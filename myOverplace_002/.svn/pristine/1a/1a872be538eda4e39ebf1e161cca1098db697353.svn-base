angular.module("eventi.services",[]).factory("Eventi",["$http","$q","$cordovaCamera","$ionicPopup","ApiConfig","Cache",function(e,i,t,n,a,o){var r=this;return r.page=1,r.more=!0,o.eventiCache=[],o.eventiCacheId={},r.moreList=function(){var t=i.defer(),n={},s=a.ovpEndpoint+"eventi/"+window.localStorage.id_scheda+"/"+r.page+"/fields";return n[a.wsKey]="JSON_CALLBACK",n.nocache=(new Date).getTime(),e({method:"JSONP",url:s,params:n,cache:!1}).success(function(e){for(var i=[],n=e.response,a=e.response.length,s=0;a>s;s++){if(n[s].facebook="1"==n[s].facebook?!0:!1,n[s].twitter="1"==n[s].twitter?!0:!1,o.eventiCacheId.hasOwnProperty(n[s].id)){var d=angular.extend({},o.eventiCacheId[n[s].id]),c=angular.extend({},n[s]);if(delete d.$$hashKey,delete c.$$hashKey,!equals(d,c,!1)){var l=o.eventiCache.indexOf(o.eventiCacheId[n[s].id]);o.eventiCache[l]=n[s],o.eventiCacheId[n[s].id]=n[s]}}else o.eventiCacheId[n[s].id]=n[s],o.eventiCache.push(n[s]);i.push(n[s].id)}if(1==r.page)for(var v in o.eventiCacheId)-1==i.indexOf(v)&&(o.eventiCache.splice(o.eventiCache.indexOf(o.eventiCacheId[v]),1),delete o.eventiCacheId[v]);r.more=e.more,t.resolve(o.eventiCache)}).error(function(){t.reject()}),t.promise},this.camera=function(e){var a=i.defer();return t.getPicture(e).then(function(i){var t=(document.getElementById("box-image-evento"),new Image);t.src="data:image/jpeg;base64,"+i,t.onload=function(){if(this.width<this.height){var t;t=e.hasOwnProperty("mediaType")&&0==e.mediaType?"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Scegli un'altra immagine.":"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Ruota lo smartphone.";var o=n.confirm({title:"Attenzione",template:t,okText:"OK",cancelText:"Annulla"});o.then(function(i){i&&r.camera(e)})}else a.resolve("data:image/jpeg;base64,"+i)}},function(e){"Selection cancelled."!=e&&"Camera cancelled."!=e&&n.alert({title:"Attenzione",template:"L'immagine non pu&ograve; essere utilizzata in quanto non risiede fisicamente sul tuo device."}),a.reject()}),a.promise},{refreshList:function(){r.page=1;var e=i.defer();return r.moreList().then(function(i){e.resolve(i)},function(){e.reject()}),e.promise},loadMore:function(){return void 0!==o.eventiCache&&Object.keys(o.eventiCache).length>0?(r.page++,r.moreList()):(r.page=1,r.moreList())},getList:function(){return void 0!==o.eventiCache&&Object.keys(o.eventiCache).length>0?o.eventiCache:this.refreshList()},getMoreStatus:function(){return void 0==r.more?!1:r.more},get:function(e){return o.eventiCacheId[e]},create:function(t){var t=angular.extend({},t),n=i.defer(),r=new Date(t.data_inizio_evento),s=new Date(t.data_fine_evento),d=a.ovpEndpointHmac+"app/post/eventi/"+window.localStorage.id_scheda,c={operation:"create",titolo:t.titolo,descrizione:t.testo,filename:t.filename};return void 0!==t.id_lista_email&&(c.id_lista_email=t.id_lista_email,c.email=!0),void 0!==t.id_lista_sms&&(c.id_lista_sms=t.id_lista_sms,c.sms=!0),c.data_inizio_evento=r.toISOString().slice(0,10),c.ora_inizio=r.getHours()+":"+r.getMinutes()+":00",c.data_fine_evento=s.toISOString().slice(0,10),c.ora_fine=s.getHours()+":"+s.getMinutes()+":00",t.twitter&&(c.twitter=!0),e({method:"POST",url:d,data:JSON.stringify(c).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))n.reject();else{var i={pendenti:{email:!1,sms:!1,push:!1},inviate:{email:0,sms:0,push:0}};for(var a in e)"success"!=a&&"notifiche"!=a&&(t[a]=e[a]),"notifiche"==a&&(void 0!=e[a].pendenti.email&&(i.pendenti.email=e[a].pendenti.email),void 0!=e[a].pendenti.sms&&(i.pendenti.sms=e[a].pendenti.sms));t.id=t.id.toString(),t.notifiche=i;var r=new Date(t.data_inizio_evento);t.data_inizio_evento=r.toISOString();var s=new Date(t.data_fine_evento);t.data_fine_evento=s.toISOString(),void 0!==o.eventiCache&&o.eventiCache.unshift(t),o.eventiCacheId[e.id]=t,n.resolve(e)}}).error(function(){n.reject()}),n.promise},update:function(t,n){var r=i.defer(),s=new Date(t.data_inizio_evento),d=new Date(t.data_fine_evento),c=a.ovpEndpointHmac+"app/post/eventi/"+window.localStorage.id_scheda,l={operation:"edit",id:t.id,data_inizio:t.data_inizio,token:t.token,titolo:t.titolo,descrizione:t.testo};return l.data_inizio_evento=s.toISOString().slice(0,10),l.ora_inizio=s.getHours()+":"+s.getMinutes()+":00",l.data_fine_evento=d.toISOString().slice(0,10),l.ora_fine=d.getHours()+":"+d.getMinutes()+":00",n&&(l.filename=t.filename),void 0!==t.id_lista_email&&(l.id_lista_email=t.id_lista_email),void 0!==t.id_lista_sms&&(l.id_lista_sms=t.id_lista_sms),t.twitter&&(l.twitter=!0),e({method:"POST",url:c,data:JSON.stringify(l).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))r.reject();else{var i=o.eventiCache.indexOf(o.eventiCacheId[t.id]);for(var n in e)t.hasOwnProperty(n)&&(t[n]=e[n]),"notifiche"==n&&(void 0!==e[n].pendenti&&(void 0!=e[n].pendenti.email&&(t.notifiche.pendenti.email=e[n].pendenti.email),void 0!=e[n].pendenti.sms&&(t.notifiche.pendenti.sms=e[n].pendenti.sms)),void 0!==e[n].inviate&&(void 0!=e[n].inviate.email&&(t.notifiche.inviate.email=e[n].inviate.email),void 0!=e[n].inviate.sms&&(t.notifiche.inviate.sms=e[n].inviate.sms)));o.eventiCache[i]=t,o.eventiCacheId[t.id]=t,r.resolve(e)}}).error(function(){r.reject()}),r.promise},"delete":function(t){var n=i.defer(),r=a.ovpEndpointHmac+"app/post/eventi/"+window.localStorage.id_scheda,s={operation:"delete",id:t.id,data_inizio:t.data_inizio,token:t.token};return e({method:"POST",url:r,data:JSON.stringify(s).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?n.reject():(-1!=o.eventiCache.indexOf(o.eventiCacheId[e.id])&&(o.eventiCache.splice(o.eventiCache.indexOf(o.eventiCacheId[e.id]),1),delete o.eventiCacheId[e.id]),n.resolve(o.eventiCache))}).error(function(){n.reject()}),n.promise},useCamera:function(e){var t=i.defer();return r.camera(e).then(function(e){t.resolve(e)},function(){t.reject()}),t.promise}}}]);