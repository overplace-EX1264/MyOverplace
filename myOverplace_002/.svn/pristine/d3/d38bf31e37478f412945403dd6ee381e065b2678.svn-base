angular.module("news.services",[]).factory("News",["$http","$q","$cordovaCamera","$ionicPopup","ApiConfig","Cache",function(e,i,a,n,t,o){var s=this;return s.page=1,s.more=!0,o.newsCache=[],o.newsCacheId={},s.moreList=function(){var a=i.defer(),n={},r=t.ovpEndpoint+"news/"+window.localStorage.id_scheda+"/"+s.page+"/fields";return n[t.wsKey]="JSON_CALLBACK",n.nocache=(new Date).getTime(),e({method:"JSONP",url:r,params:n,cache:!1}).success(function(e){for(var i=[],n=e.response,t=e.response.length,r=0;t>r;r++){if(n[r].facebook="1"==n[r].facebook?!0:!1,n[r].twitter="1"==n[r].twitter?!0:!1,o.newsCacheId.hasOwnProperty(n[r].id)){var c=angular.extend({},o.newsCacheId[n[r].id]),d=angular.extend({},n[r]);if(delete c.$$hashKey,delete d.$$hashKey,!equals(c,d,!1)){var l=o.newsCache.indexOf(o.newsCacheId[n[r].id]);o.newsCache[l]=n[r],o.newsCacheId[n[r].id]=n[r]}}else o.newsCacheId[n[r].id]=n[r],o.newsCache.push(n[r]);i.push(n[r].id)}if(1==s.page)for(var m in o.newsCacheId)-1==i.indexOf(m)&&(o.newsCache.splice(o.newsCache.indexOf(o.newsCacheId[m]),1),delete o.newsCacheId[m]);s.more=e.more,a.resolve(o.newsCache)}).error(function(){a.reject()}),a.promise},this.camera=function(e){var t=i.defer();return a.getPicture(e).then(function(i){var a=(document.getElementById("box-image-news"),new Image);a.src="data:image/jpeg;base64,"+i,a.onload=function(){if(this.width<this.height){var a;a=e.hasOwnProperty("mediaType")&&0==e.mediaType?"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Scegli un'altra immagine.":"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Ruota lo smartphone.",n.alert({title:"Attenzione",template:a})}else t.resolve("data:image/jpeg;base64,"+i)}},function(e){"Selection cancelled."!=e&&"Camera cancelled."!=e&&"no image selected"!=e&&n.alert({title:"Attenzione",template:"L'immagine non pu&ograve; essere utilizzata in quanto non risiede fisicamente sul tuo device."}),t.reject()}),t.promise},{refreshList:function(){s.page=1;var e=i.defer();return s.moreList().then(function(i){e.resolve(i)},function(){e.reject()}),e.promise},loadMore:function(){return void 0!==o.newsCache&&Object.keys(o.newsCache).length>0?(s.page++,s.moreList()):(s.page=1,s.moreList())},getMoreStatus:function(){return void 0==s.more?!1:s.more},getList:function(){return void 0!==o.newsCache&&Object.keys(o.newsCache).length>0?o.newsCache:this.refreshList()},get:function(e){return o.newsCacheId[e]},create:function(a){var a=angular.extend({},a),n=i.defer(),s=new Date,r=new Date(a.data_inizio_pubblicazione),c=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,d={operation:"create",titolo:a.titolo,messaggio:a.testo,filename:a.filename};return void 0!==a.id_lista_email&&(d.id_lista_email=a.id_lista_email,d.email=!0),void 0!==a.id_lista_sms&&(d.id_lista_sms=a.id_lista_sms,d.sms=!0),r.getTime()>s.getTime()&&(d.data_inizio_pubblicazione=r.toISOString().slice(0,10),d.ora_inizio=r.getHours()+":"+r.getMinutes()+":00"),a.facebook&&(d.facebook=!0),a.twitter&&(d.twitter=!0),e({method:"POST",url:c,data:JSON.stringify(d).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))n.reject();else{var i={pendenti:{email:!1,sms:!1,push:!1},inviate:{email:0,sms:0,push:0}};for(var t in e)"success"!=t&&"notifiche"!=t&&(a[t]=e[t]),"notifiche"==t&&(void 0!=e[t].pendenti.email&&(i.pendenti.email=e[t].pendenti.email),void 0!=e[t].pendenti.sms&&(i.pendenti.sms=e[t].pendenti.sms));a.id=a.id.toString(),a.notifiche=i;var s=new Date(a.data_inizio_pubblicazione);a.data_inizio_pubblicazione=s.toISOString(),void 0!==o.newsCache&&o.newsCache.unshift(a),o.newsCacheId[e.id]=a,n.resolve(e)}}).error(function(){n.reject()}),n.promise},update:function(a,n){var s=i.defer(),r=new Date,c=new Date(a.data_inizio_pubblicazione),d=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,l={operation:"edit",id:a.id,data_inizio:a.data_inizio,token:a.token,titolo:a.titolo,messaggio:a.testo};return c.getTime()>r.getTime()&&(l.data_inizio_pubblicazione=c.toISOString().slice(0,10),l.ora_inizio=c.getHours()+":"+c.getMinutes()+":00"),n&&(l.filename=a.filename),void 0!==a.id_lista_email&&(l.id_lista_email=a.id_lista_email),void 0!==a.id_lista_sms&&(l.id_lista_sms=a.id_lista_sms),a.facebook&&(l.facebook=!0),a.twitter&&(l.twitter=!0),e({method:"POST",url:d,data:JSON.stringify(l).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))s.reject();else{var i=o.newsCache.indexOf(o.newsCacheId[a.id]);for(var n in e)a.hasOwnProperty(n)&&(a[n]=e[n]),"notifiche"==n&&(void 0!==e[n].pendenti&&(void 0!=e[n].pendenti.email&&(a.notifiche.pendenti.email=e[n].pendenti.email),void 0!=e[n].pendenti.sms&&(a.notifiche.pendenti.sms=e[n].pendenti.sms)),void 0!==e[n].inviate&&(void 0!=e[n].inviate.email&&(a.notifiche.inviate.email=e[n].inviate.email),void 0!=e[n].inviate.sms&&(a.notifiche.inviate.sms=e[n].inviate.sms)));o.newsCache[i]=a,o.newsCacheId[a.id]=a,s.resolve(e)}}).error(function(){s.reject()}),s.promise},"delete":function(a){var n=i.defer(),s=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,r={operation:"delete",id:a.id,data_inizio:a.data_inizio,token:a.token};return e({method:"POST",url:s,data:JSON.stringify(r).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?n.reject():(-1!=o.newsCache.indexOf(o.newsCacheId[e.id])&&(o.newsCache.splice(o.newsCache.indexOf(o.newsCacheId[e.id]),1),delete o.newsCacheId[e.id]),n.resolve(o.newsCache))}).error(function(){n.reject()}),n.promise},useCamera:function(e){var a=i.defer();return s.camera(e).then(function(e){a.resolve(e)},function(){a.reject()}),a.promise}}}]);