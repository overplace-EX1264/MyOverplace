angular.module("rubrica.services",[]).factory("Rubrica",["$http","$q","$cordovaToast","$cordovaContacts","$ionicPopup","ApiConfig","Cache",function(e,a,t,o,n,r,c){var s=this;return s.page=1,s.more=!0,c.wmcContactCache=[],c.wmcContactCacheId={},c.contactCache=[],c.contactCacheId={},s.readAll=function(){var t=a.defer(),o=r.ovpEndpointHmac+"app/post/rubrica/"+window.localStorage.id_scheda,n={operation:"read"};return e({method:"POST",url:o,data:JSON.stringify(n).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))t.reject();else{for(var a=[],o=e.response,n=e.response.length,r=0;n>r;r++){if(o[r].photos=new Array,o[r].photos.push("https://www.overplace.com/avatar/ovp/avatar_default.png"),c.wmcContactCacheId.hasOwnProperty(o[r].id)){var s=angular.extend({},c.wmcContactCacheId[o[r].id]),i=angular.extend({},o[r]);if(delete s.$$hashKey,delete i.$$hashKey,!equals(s,i,!1)){var l=c.wmcContactCache.indexOf(c.wmcContactCacheId[o[r].id]);c.wmcContactCache[l]=o[r],c.wmcContactCacheId[o[r].id]=o[r]}}else(""!=o[r].telefono||""!=o[r].email)&&(c.wmcContactCacheId[o[r].id]=o[r],c.wmcContactCache.push(o[r]));a.push(o[r].id)}for(var m in c.wmcContactCacheId)-1==a.indexOf(m)&&(c.wmcContactCache.splice(c.wmcContactCache.indexOf(c.wmcContactCacheId[m]),1),delete c.wmcContactCacheId[m]);t.resolve(c.wmcContactCache)}}).error(function(){t.reject({code:1,message:"Impossibile recuperare i contatti dal wmc."})}),t.promise},s.readContact=function(){var e=a.defer();return o.find({multiple:!0}).then(function(a){var t=a.length;if(0==t)e.reject({code:2,message:"Nessun contatto presente"});else{for(var o,n,r,c,s,i=new Array,l=0;t>l;l++)if(o=a[l],null!=o.phoneNumbers||null!=o.emails){if(n=new Array,r=new Array,c=new Array,null!=o.phoneNumbers)for(var m=0;m<o.phoneNumbers.length;m++)n.push(o.phoneNumbers[m].value.split(" ").join(""));if(null!=o.emails)for(var m=0;m<o.emails.length;m++)r.push(o.emails[m].value);if(null!=o.photos)for(var m=0;m<o.photos.length;m++)c.push(o.photos[m].value);else c.push("https://www.overplace.com/avatar/ovp/avatar_default.png");(0!=n.length||0!=r.length)&&(ionic.Platform.isIOS()?(s="",null!=o.name.givenName&&(s+=o.name.givenName+" "),null!=o.name.middleName&&(s+=o.name.middleName+" "),null!=o.name.familyName&&(s+=o.name.familyName)):s=o.displayName,(null==s||""==s)&&(s=r.length>0?r[0]:n[0]),i.push({id:o.id,name:s,numbers:n,emails:r,photos:c,status:{telefono:!1,email:!1,checked:!1}}))}i.length>0?e.resolve(i):e.reject({code:3,message:"Nessun contatto valido."})}},function(){e.reject({code:4,message:"Impossibile recuperare i contatti dal dispositivo."})}),e.promise},{upload:function(t){var o=a.defer(),n=r.ovpEndpointHmac+"app/post/rubrica/"+window.localStorage.id_scheda,c={operation:"upload",contatti:t};return e({method:"POST",url:n,data:JSON.stringify(c).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?o.reject():o.resolve()}).error(function(){o.reject()}),o.promise},sincro:function(){var e=new Array,t=a.defer();return s.readContact().then(function(a){s.readAll().then(function(o){var n=a.length,r=o.length;if(0==r)e=a;else{var c,s,i,l,m,h,u,d,p,f=new Array,v=new Array;for(u=0;n>u;u++){for(c=a[u],f=new Array,v=new Array,d=0;d<c.numbers.length;d++)if(i=c.numbers[d],""!=i&&-1===f.indexOf(i)){for(s=!0,p=0;r>p;p++)if(l=o[p].telefono,i==l){s=!1;break}s&&f.push(i)}for(d=0;d<c.emails.length;d++)if(m=c.emails[d],""!=m&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m)){for(s=!0,p=0;r>p;p++)if(h=o[p].email,m==h){s=!1;break}s&&v.push(m)}(f.length>0||v.length>0)&&e.push({id:c.id,name:c.name,numbers:f,emails:v,photos:c.photos,status:c.status})}}e.sort(function(e,a){var t=e.name.toLowerCase(),o=a.name.toLowerCase();return o>t?-1:t>o?1:0}),t.resolve(e)},function(){e=a})},function(e){t.reject(e)}),t.promise},saveContact:function(e){var n=a.defer(),r={displayName:e.nome,phoneNumbers:[{type:"mobile",value:e.telefono}],emails:[{type:"other",value:e.email}]};return o.save(r).then(function(){delete c.wmcContactCacheId[e.id],c.wmcContactCache.splice(c.wmcContactCache.indexOf(e),1),n.resolve(!0),t.show("Contatto salvato!","short","bottom")},function(){n.resolve(!1),t.show("Errore nel salvataggio del contatto!","short","bottom")}),n.promise}}}]);