angular.module("promozioni.services",[]).factory("Promozioni",["$http","$q","$cordovaToast","$ionicPopup","ApiConfig","Cache",function(i,e,o,n,t,r){var a=this;return this.getAll=function(){var o=e.defer();r.promozioniCache=[],r.promozioniCacheId={};var n={},a=t.ovpEndpoint+"promozioni/"+window.localStorage.id_scheda+"/fields";return n[t.wsKey]="JSON_CALLBACK",i({method:"JSONP",url:a,params:n,cache:!1}).success(function(i){for(var e=i.length,n=0;e>n;n++)i[n].facebook="1"==i[n].facebook?!0:!1,i[n].twitter="1"==i[n].twitter?!0:!1,r.promozioniCacheId[i[n].id]=i[n];r.promozioniCache=i,o.resolve(r.promozioniCache)}).error(function(){o.reject()}),o.promise},{refreshList:function(){var i=e.defer();return a.getAll().then(function(e){i.resolve(e)},function(){i.reject()}),i.promise},getList:function(){return void 0!==r.promozioniCache?r.promozioniCache:this.refreshList()},get:function(i){return r.promozioniCacheId[i]},update:function(o){var n=e.defer(),a=t.ovpEndpointHmac+"app/post/promozioni/"+window.localStorage.id_scheda,s={operation:"edit",id:o.id,data_inizio:o.data_inizio,token:o.token,descrizione:o.descrizione};return void 0!==o.id_lista_email&&(s.id_lista_email=o.id_lista_email),void 0!==o.id_lista_sms&&(s.id_lista_sms=o.id_lista_sms),o.facebook&&(s.facebook=!0),o.twitter&&(s.twitter=!0),i({method:"POST",url:a,data:JSON.stringify(s).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(i){if(0!=i.hasOwnProperty("error"))n.reject();else{r.promozioniCache.splice(r.promozioniCache.indexOf(o),1);var e={pendenti:{email:0,sms:0,push:0},inviate:{email:0,sms:0,push:0}};for(var t in i)o.hasOwnProperty(t)&&(o[t]=i[t]),"notifiche"==t&&(void 0!==i[t].pendenti&&(void 0!=i[t].pendenti.email&&(e.pendenti.email=i[t].pendenti.email),void 0!=i[t].pendenti.sms&&(e.pendenti.sms=i[t].pendenti.sms)),void 0!==i[t].inviate&&(void 0!=i[t].inviate.email&&(e.inviate.email=i[t].inviate.email),void 0!=i[t].inviate.sms&&(e.inviate.sms=i[t].inviate.sms)));o.notifiche=e,r.promozioniCache.unshift(o),n.resolve(i)}}).error(function(){n.reject()}),n.promise}}}]);