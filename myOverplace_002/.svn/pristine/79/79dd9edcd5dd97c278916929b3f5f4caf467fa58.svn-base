angular.module("news.services",[]).factory("News",["$http","$q","$cordovaCamera","$ionicPopup","ApiConfig","Cache",function(e,i,n,a,t,o){var s=this;return s.page=1,s.more=!0,o.newsCache=[],o.newsCacheId={},s.moreList=function(){var n=i.defer(),a={},r=t.ovpEndpoint+"news/"+window.localStorage.id_scheda+"/"+s.page+"/fields";return a[t.wsKey]="JSON_CALLBACK",a.nocache=(new Date).getTime(),e({method:"JSONP",url:r,params:a,cache:!1}).success(function(e){for(var i=[],a=e.response,t=e.response.length,r=0;t>r;r++){if(a[r].facebook="1"==a[r].facebook?!0:!1,a[r].twitter="1"==a[r].twitter?!0:!1,o.newsCacheId.hasOwnProperty(a[r].id)){var c=angular.extend({},o.newsCacheId[a[r].id]),d=angular.extend({},a[r]);if(delete c.$$hashKey,delete d.$$hashKey,!equals(c,d,!1)){var l=o.newsCache.indexOf(o.newsCacheId[a[r].id]);o.newsCache[l]=a[r],o.newsCacheId[a[r].id]=a[r]}}else o.newsCacheId[a[r].id]=a[r],o.newsCache.push(a[r]);i.push(a[r].id)}if(1==s.page)for(var m in o.newsCacheId)-1==i.indexOf(m)&&(o.newsCache.splice(o.newsCache.indexOf(o.newsCacheId[m]),1),delete o.newsCacheId[m]);s.more=e.more,n.resolve(o.newsCache)}).error(function(){n.reject()}),n.promise},this.camera=function(e){var t=i.defer();return n.getPicture(e).then(function(i){var n=(document.getElementById("box-image-news"),new Image);n.src="data:image/jpeg;base64,"+i,n.onload=function(){if(this.width<this.height){var n;n=e.hasOwnProperty("mediaType")&&0==e.mediaType?"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Scegli un'altra immagine.":"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Ruota lo smartphone.";var o=a.confirm({title:"Attenzione",template:n,okText:"OK",cancelText:"Annulla"});o.then(function(i){i&&s.camera(e)})}else t.resolve("data:image/jpeg;base64,"+i)}},function(e){"Selection cancelled."!=e&&"Camera cancelled."!=e&&a.alert({title:"Attenzione",template:"L'immagine non pu&ograve; essere utilizzata in quanto non risiede fisicamente sul tuo device."}),t.reject()}),t.promise},{refreshList:function(){s.page=1;var e=i.defer();return s.moreList().then(function(i){e.resolve(i)},function(){e.reject()}),e.promise},loadMore:function(){return void 0!==o.newsCache&&Object.keys(o.newsCache).length>0?(s.page++,s.moreList()):(s.page=1,s.moreList())},getMoreStatus:function(){return void 0==s.more?!1:s.more},getList:function(){return void 0!==o.newsCache&&Object.keys(o.newsCache).length>0?o.newsCache:this.refreshList()},get:function(e){return o.newsCacheId[e]},create:function(n){var n=angular.extend({},n),a=i.defer(),s=new Date,r=new Date(n.data_inizio_pubblicazione),c=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,d={operation:"create",titolo:n.titolo,messaggio:n.testo,filename:n.filename};return void 0!==n.id_lista_email&&(d.id_lista_email=n.id_lista_email,d.email=!0),void 0!==n.id_lista_sms&&(d.id_lista_sms=n.id_lista_sms,d.sms=!0),r.getTime()>s.getTime()&&(d.data_inizio_pubblicazione=r.toISOString().slice(0,10),d.ora_inizio=r.getHours()+":"+r.getMinutes()+":00"),n.facebook&&(d.facebook=!0),n.twitter&&(d.twitter=!0),e({method:"POST",url:c,data:JSON.stringify(d).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))a.reject();else{var i={pendenti:{email:!1,sms:!1,push:!1},inviate:{email:0,sms:0,push:0}};for(var t in e)"success"!=t&&"notifiche"!=t&&(n[t]=e[t]),"notifiche"==t&&(void 0!=e[t].pendenti.email&&(i.pendenti.email=e[t].pendenti.email),void 0!=e[t].pendenti.sms&&(i.pendenti.sms=e[t].pendenti.sms));n.id=n.id.toString(),n.notifiche=i;var s=new Date(n.data_inizio_pubblicazione);n.data_inizio_pubblicazione=s.toISOString(),void 0!==o.newsCache&&o.newsCache.unshift(n),o.newsCacheId[e.id]=n,a.resolve(e)}}).error(function(){a.reject()}),a.promise},update:function(n,a){var s=i.defer(),r=new Date,c=new Date(n.data_inizio_pubblicazione),d=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,l={operation:"edit",id:n.id,data_inizio:n.data_inizio,token:n.token,titolo:n.titolo,messaggio:n.testo};return c.getTime()>r.getTime()&&(l.data_inizio_pubblicazione=c.toISOString().slice(0,10),l.ora_inizio=c.getHours()+":"+c.getMinutes()+":00"),a&&(l.filename=n.filename),void 0!==n.id_lista_email&&(l.id_lista_email=n.id_lista_email),void 0!==n.id_lista_sms&&(l.id_lista_sms=n.id_lista_sms),n.facebook&&(l.facebook=!0),n.twitter&&(l.twitter=!0),e({method:"POST",url:d,data:JSON.stringify(l).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))s.reject();else{var i=o.newsCache.indexOf(o.newsCacheId[n.id]);for(var a in e)n.hasOwnProperty(a)&&(n[a]=e[a]),"notifiche"==a&&(void 0!==e[a].pendenti&&(void 0!=e[a].pendenti.email&&(n.notifiche.pendenti.email=e[a].pendenti.email),void 0!=e[a].pendenti.sms&&(n.notifiche.pendenti.sms=e[a].pendenti.sms)),void 0!==e[a].inviate&&(void 0!=e[a].inviate.email&&(n.notifiche.inviate.email=e[a].inviate.email),void 0!=e[a].inviate.sms&&(n.notifiche.inviate.sms=e[a].inviate.sms)));o.newsCache[i]=n,o.newsCacheId[n.id]=n,s.resolve(e)}}).error(function(){s.reject()}),s.promise},"delete":function(n){var a=i.defer(),s=t.ovpEndpointHmac+"app/post/news/"+window.localStorage.id_scheda,r={operation:"delete",id:n.id,data_inizio:n.data_inizio,token:n.token};return e({method:"POST",url:s,data:JSON.stringify(r).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?a.reject():(-1!=o.newsCache.indexOf(o.newsCacheId[e.id])&&(o.newsCache.splice(o.newsCache.indexOf(o.newsCacheId[e.id]),1),delete o.newsCacheId[e.id]),a.resolve(o.newsCache))}).error(function(){a.reject()}),a.promise},useCamera:function(e){var n=i.defer();return s.camera(e).then(function(e){n.resolve(e)},function(){n.reject()}),n.promise}}}]);