angular.module("rubrica.controllers",[]).controller("RubricaCtrl",["$scope","$timeout","$ionicPopover","$ionicPopup","$ionicLoading","$cordovaToast","Rubrica",function(t,e,o,n,c,l,a){var i=[],r=0,s=10,h=!1;t.contatti=[],t.contact_selected=[],t.filter={value:"0"},t.popover=null,t.allSelected=!1,t.hasMoreContact=!1,t.selectContact=function(e){if(e.checked=!e.checked,e.checked)t.contact_selected.push(e),t.contact_selected.length==t.contatti.length&&(t.allSelected=!0);else{var o=t.contact_selected.indexOf(e);o>-1&&(t.contact_selected.splice(o,1),t.allSelected=!1)}},t.selectAll=function(){var e,o;for(t.contact_selected=[],e=0;e<i.length;e++)o=i[e],o.checked=!0,t.contact_selected.push(o);t.allSelected=!0},t.deselectAll=function(){var e,o;for(e=0;e<i.length;e++)o=i[e],o.checked=!1;t.contact_selected=[],t.allSelected=!1},t.sincronizza=function(){null!=t.popover&&t.popover.hide(),c.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),a.sincro().then(function(e){c.hide(),0==e.length?(t.contatti=[],i=[],l.show("Tutti i contatti validi sono stati caricati","long","bottom")):(r=0,i=e,t.deselectAll(),i.length>s?(t.hasMoreContact=!0,h&&(t.contatti=[],t.loadMoreContact())):t.contatti=e,h=!0,t.contact_selected=[],t.allSelected=!1)},function(t){c.hide(),l.show(t.message,"short","bottom")})},t.showOptions=function(e){t.popover=o.fromTemplateUrl("templates/partial/rubrica/nav_menu_options.html",{scope:t}).then(function(o){t.popover=o,t.popover.show(e)})},t.refresh=function(){a.sincro().then(function(e){c.hide(),0==e.length?(t.contatti=[],i=[],l.show("Tutti i contatti validi sono stati caricati","long","bottom")):(r=0,i=e,t.deselectAll(),i.length>s?(t.hasMoreContact=!0,h&&(t.contatti=[],t.loadMoreContact())):t.contatti=e,h=!0,t.contact_selected=[],t.allSelected=!1),t.$broadcast("scroll.refreshComplete")},function(e){c.hide(),l.show(e,"short","bottom"),t.$broadcast("scroll.refreshComplete")})},t.loadMoreContact=function(){if(t.hasMoreContact){var e=r*s,o=r*s+s;if(e>i.length-1)return void(t.hasMoreContact=!1);o>i.length&&(o=i.length);for(var n=e;o>n;n++)t.contatti.push(i[n]);r++,t.$broadcast("scroll.infiniteScrollComplete")}},t.uploadContact=function(){return 0==t.contact_selected.length?void l.show("Nessun contatto selezionato","short","bottom"):(c.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),void a.upload(t.contact_selected).then(function(){c.hide(),l.show(t.contact_selected.length+" contatti caricati!","short","bottom"),t.contact_selected=[],t.allSelected=!1,t.sincronizza()},function(){c.hide(),l.show("Impossibile caricare i contatti selezionati!","short","bottom"),t.deselectAll()}))},t.showFilter=function(){if(0==t.contatti.length)return l.show("Non ci sono contatti da filtrare","short","bottom"),!0;t.popover.hide();var e=n.confirm({title:"Filtra contatti per",templateUrl:"templates/partial/rubrica/filter.html",scope:t,okText:"Filtra",cancelText:"Pulisci"});e.then(function(e){for(var o in i)i[o].checked=!1;if(t.contact_selected=[],t.allSelected=!1,e){if(c.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),t.contatti=[],"1"!=t.filter.value&&"2"!=t.filter.value)i.length>s?(t.hasMoreContact=!0,r=0,t.loadMoreContact()):t.contatti=i,t.filter.value="0",c.hide();else if("1"==t.filter.value){for(var o=0;o<i.length;o++)i[o].emails.length>0&&t.contatti.push(i[o]);t.hasMoreContact=!1,c.hide(),l.show(t.contatti.length+" contatti trovati","short","bottom")}else if("2"==t.filter.value){for(var o=0;o<i.length;o++)i[o].numbers.length>0&&t.contatti.push(i[o]);t.hasMoreContact=!1,c.hide(),l.show(t.contatti.length+" contatti trovati","short","bottom")}}else i.length>s?(r=0,t.loadMoreContact(),t.hasMoreContact=!0):t.contatti=i,t.filter.value="0",c.hide()})},t.$on("$destroy",function(){t.popover.remove(),t.popover=null}),t.$on("popover.hidden",function(){}),t.$on("popover.removed",function(){})}]);