angular.module("coupon.services",[]).factory("Coupon",["$http","$q","$cordovaCamera","$ionicPopup","ApiConfig","Cache",function(e,i,o,n,a,t){var c=this;return c.page=1,c.more=!0,t.couponCache=[],t.couponCacheId={},c.moreList=function(){var o=i.defer(),n={},r=a.ovpEndpoint+"coupon/"+window.localStorage.id_scheda+"/"+c.page+"/fields";return n[a.wsKey]="JSON_CALLBACK",n.nocache=(new Date).getTime(),e({method:"JSONP",url:r,params:n,cache:!1}).success(function(e){for(var i=[],n=e.response,a=e.response.length,r=0;a>r;r++){if(n[r].facebook="1"==n[r].facebook?!0:!1,n[r].twitter="1"==n[r].twitter?!0:!1,t.couponCacheId.hasOwnProperty(n[r].id)){var d=angular.extend({},t.couponCacheId[n[r].id]),s=angular.extend({},n[r]);if(delete d.$$hashKey,delete s.$$hashKey,!equals(d,s,!1)){var u=t.couponCache.indexOf(t.couponCacheId[n[r].id]);t.couponCache[u]=n[r],t.couponCacheId[n[r].id]=n[r]}}else t.couponCacheId[n[r].id]=n[r],t.couponCache.push(n[r]);i.push(n[r].id)}if(1==c.page)for(var l in t.couponCacheId)-1==i.indexOf(l)&&(t.couponCache.splice(t.couponCache.indexOf(t.couponCacheId[l]),1),delete t.couponCacheId[l]);c.more=e.more,o.resolve(t.couponCache)}).error(function(){o.reject()}),o.promise},this.camera=function(e){var a=i.defer();return o.getPicture(e).then(function(i){var o=(document.getElementById("box-image-coupon"),new Image);o.src="data:image/jpeg;base64,"+i,o.onload=function(){if(this.width<this.height){var o;o=e.hasOwnProperty("mediaType")&&0==e.mediaType?"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Scegli un'altra immagine.":"La larghezza dell'immagine deve essere superiore alla sua altezza!<br>Ruota lo smartphone.",n.alert({title:"Attenzione",template:o})}else a.resolve("data:image/jpeg;base64,"+i)}},function(e){"Selection cancelled."!=e&&"Camera cancelled."!=e&&"no image selected"!=e&&n.alert({title:"Attenzione",template:"L'immagine non pu&ograve; essere utilizzata in quanto non risiede fisicamente sul tuo device."}),a.reject()}),a.promise},{refreshList:function(){c.page=1;var e=i.defer();return c.moreList().then(function(i){e.resolve(i)},function(){e.reject()}),e.promise},loadMore:function(){return void 0!==t.couponCache&&Object.keys(t.couponCache).length>0?(c.page++,c.moreList()):(c.page=1,c.moreList())},getMoreStatus:function(){return void 0==c.more?!1:c.more},getList:function(){return void 0!==t.couponCache&&Object.keys(t.couponCache).length>0?t.couponCache:this.refreshList()},get:function(e){return t.couponCacheId[e]},useCamera:function(e){var o=i.defer();return c.camera(e).then(function(e){o.resolve(e)},function(){o.reject()}),o.promise},scadenza_coupon:function(e,i){var o=new Date(e),n=o.getDate()+parseInt(i);return o.setDate(n),o.getTime()},checkDate:function(o,n){var t=new Date(o).toISOString().slice(0,10),c=new Date(n).toISOString().slice(0,10),r=i.defer(),d={},s=a.ovpEndpointHmac+"app/post/coupon_check_date/"+window.localStorage.id_scheda;return d.data_inizio_erogazione=t,d.data_fine_erogazione=c,e({method:"POST",url:s,data:JSON.stringify(d).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},create:function(o){var o=angular.extend({},o),n=i.defer(),c=new Date(o.data_inizio_erogazione),r=new Date(o.data_fine_erogazione),d=a.ovpEndpointHmac+"app/post/coupon/"+window.localStorage.id_scheda,s={operation:"create",titolo:o.titolo,descrizione:o.descrizione,sconto:o.sconto,condizioni_legali:o.condizioni_legali,numero_coupon_erogabili:o.numero_coupon_erogabili,coupon_illimitati:o.coupon_illimitati,data_inizio_erogazione:c.toISOString().slice(0,10),data_fine_erogazione:r.toISOString().slice(0,10),durata_coupon:o.durata_coupon,filename:o.filename};return void 0!==o.id_lista_email&&(s.id_lista_email=o.id_lista_email,s.email=!0),void 0!==o.id_lista_sms&&(s.id_lista_sms=o.id_lista_sms,s.sms=!0),o.facebook&&(s.facebook=!0),o.twitter&&(s.twitter=!0),e({method:"POST",url:d,data:JSON.stringify(s).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))n.reject();else{var i={pendenti:{email:!1,sms:!1,push:!1},inviate:{email:0,sms:0,push:0}};for(var a in e)"success"!=a&&"notifiche"!=a&&(o[a]=e[a]),"notifiche"==a&&(void 0!=e[a].pendenti.email&&(i.pendenti.email=e[a].pendenti.email),void 0!=e[a].pendenti.sms&&(i.pendenti.sms=e[a].pendenti.sms));o.id=o.id.toString(),o.notifiche=i,void 0!==t.couponCache&&t.couponCache.unshift(o),t.couponCacheId[e.id]=o,n.resolve(e)}}).error(function(){n.reject()}),n.promise},update:function(o,n){var c=i.defer(),r=new Date(o.data_inizio_erogazione),d=new Date(o.data_fine_erogazione),s=a.ovpEndpointHmac+"app/post/coupon/"+window.localStorage.id_scheda,u={operation:"edit",id:o.id,data_inizio:o.data_inizio,token:o.token,titolo:o.titolo,descrizione:o.descrizione,sconto:o.sconto,condizioni_legali:o.condizioni_legali,numero_coupon_erogabili:o.numero_coupon_erogabili,coupon_illimitati:o.coupon_illimitati,data_inizio_erogazione:r.toISOString().slice(0,10),data_fine_erogazione:d.toISOString().slice(0,10),durata_coupon:o.durata_coupon};return n&&(u.filename=o.filename),void 0!==o.id_lista_email&&(u.id_lista_email=o.id_lista_email),void 0!==o.id_lista_sms&&(u.id_lista_sms=o.id_lista_sms),o.facebook&&(u.facebook=!0),o.twitter&&(u.twitter=!0),e({method:"POST",url:s,data:JSON.stringify(u).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))c.reject();else{var i=t.couponCache.indexOf(t.couponCacheId[o.id]);for(var n in e)o.hasOwnProperty(n)&&(o[n]=e[n]),"notifiche"==n&&(void 0!=e[n].pendenti&&(void 0!=e[n].pendenti.email&&(o.notifiche.pendenti.email=e[n].pendenti.email),void 0!=e[n].pendenti.sms&&(o.notifiche.pendenti.sms=e[n].pendenti.sms)),void 0!=e[n].inviate&&(void 0!=e[n].inviate.email&&(o.notifiche.inviate.email=e[n].inviate.email),void 0!=e[n].inviate.sms&&(o.notifiche.inviate.sms=e[n].inviate.sms)));t.couponCache[i]=o,t.couponCacheId[o.id]=o,c.resolve(e)}}).error(function(){c.reject()}),c.promise},"delete":function(o){var n=i.defer(),c=a.ovpEndpointHmac+"app/post/coupon/"+window.localStorage.id_scheda,r={operation:"delete",id:o.id,data_inizio:o.data_inizio,token:o.token};return e({method:"POST",url:c,data:JSON.stringify(r).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?n.reject():(-1!=t.couponCache.indexOf(t.couponCacheId[e.id])&&(t.couponCache.splice(t.couponCache.indexOf(t.couponCacheId[e.id]),1),delete t.couponCacheId[e.id]),n.resolve(t.couponCache))}).error(function(){n.reject()}),n.promise}}}]);