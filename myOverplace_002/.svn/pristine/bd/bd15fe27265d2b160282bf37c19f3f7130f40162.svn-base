angular.module("coupon.controllers",[]).controller("CouponCtrl",["$scope","$ionicPopup","$ionicLoading","$cordovaToast","$location","$timeout","Auth","Coupon","Help",function(o,e,n,t,i,a,r,c,u){var l=r.getUserData(null);o.moduloCoupon=l.wmc_data.coupon,o.isSupport=Object.keys(l.support).length>0,o.isSupport&&(o.support_phone=l.support.phone),o.moduloCoupon?(o.coupon_list=[],o.isAvailable=!0):o.inactive=u.getModulo("coupon"),o.call=function(o){window.location.href="tel:"+o},o.loadCoupon=function(){c.loadMore().then(function(e){o.coupon_list=e,o.isAvailable=c.getMoreStatus(),o.$broadcast("scroll.infiniteScrollComplete")},function(){t.show("Attenzione! Si è verificato un errore durante il caricamento","short","bottom"),o.$broadcast("scroll.infiniteScrollComplete")})},o.delete=function(o){var i="Sei sicuro di voler cancellare il coupon?";o.facebook&&o.twitter?i+=" Verranno eliminati anche i post su Facebook e Twitter.":o.facebook?i+=" Verr� eliminato anche il post su Facebook.":o.twitter&&(i+=" Verr� eliminato anche il post su Twitter.");var a=e.confirm({title:"Attenzione",template:i,okText:"Si",cancelText:"No"});a.then(function(e){e&&(n.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),c.delete(o).then(function(){n.hide(),t.show("Coupon eliminato con successo","short","bottom")},function(){n.hide(),t.show("Errore eliminazione coupon","short","bottom")}))})},o.edit=function(o){i.path("/app/coupon/"+o+"/edit")},o.refresh=function(){c.refreshList().then(function(e){o.coupon_list=e,o.isAvailable=c.getMoreStatus(),o.$broadcast("scroll.refreshComplete")},function(){t.show("Errore nel recupero dei coupon!","short","bottom"),o.$broadcast("scroll.refreshComplete")})}}]).controller("CouponDetailCtrl",["$scope","$stateParams","Coupon","$ionicPopup","$cordovaToast","$ionicHistory","$ionicLoading","$state","$timeout",function(o,e,n,t,i,a,r,c,u){o.coupon=n.get(e.id),o.delete=function(o){var e="Sei sicuro di voler cancellare il coupon?";void 0!==o.facebook&&o.facebook&&void 0!==o.twitter&&o.twitter?e+=" Verranno eliminati anche i post su Facebook e Twitter.":void 0!==o.facebook&&o.facebook?e+=" Verr� eliminato anche il post su Facebook.":void 0!==o.twitter&&o.twitter&&(e+=" Verr� eliminato anche il post su Twitter.");var l=t.confirm({title:"Attenzione",template:e,okText:"Si",cancelText:"No"});l.then(function(e){e&&(r.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),n.delete(o).then(function(){r.hide(),a.clearCache(),i.show("Coupon eliminato con successo","short","bottom"),u(function(){c.go("app.coupon",{reload:!0})})},function(){r.hide(),i.show("Errore eliminazione coupon","short","bottom")}))})}}]).controller("CouponWizardCtrl",["$rootScope","$scope","$cordovaDatePicker","$cordovaCamera","$cordovaToast","$ionicPopup","$ionicLoading","$ionicHistory","$timeout","Auth","Coupon",function(o,e,n,t,i,a,r,c,u,l,p){var s=l.getUserData(null);e.social=s.wmc_data.social,e.notifiche={messaggi:s.wmc_data.messaggi,app:s.wmc_data.app},e.notifiche_checkbox={email:0,sms:0},e.emptyListaContatti={email_disabled:!1,sms_disabled:!1},e.isAvailableDate=!1;var d=!1;e.coupon=[],e.coupon.twitter=!1,e.coupon.facebook=!1,e.coupon.data_inizio_erogazione=(new Date).getTime(),e.coupon.durata_coupon=2,e.coupon.data_fine_erogazione=p.scadenza_coupon(e.coupon.data_inizio_erogazione,e.coupon.durata_coupon),e.coupon.filename=s.filename.replace("/lg_","/xl_"),e.coupon.notifiche={pendenti:{email:0}},e.coupon.id_tipologia_stato=3,e.$on("wizard:StepFailed",function(n,t){if(0==t.index){if((void 0==e.coupon.numero_coupon_erogabili||0==e.coupon.numero_coupon_erogabili.length)&&!e.coupon.coupon_illimitati)return void a.alert({title:"Erogazione Coupon",template:"Inserire un numero di quanti coupon possono essere erogati o scegliere l'opzione illimitati"});if(void 0==e.coupon.sconto||0==e.coupon.sconto.length)return void a.alert({title:"Valore Coupon",template:"Inserire un valore"});e.isAvailableDate||(r.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),p.checkDate(e.coupon.data_inizio_erogazione,e.coupon.data_fine_erogazione).then(function(n){e.isAvailableDate=n,r.hide(),n?o.$broadcast("wizard:Next"):a.alert({title:"Attenzione",template:"Per le date selezionate &egrave; gi&agrave; presente un altro coupon!"})},function(){r.hide(),i.show("Errore date coupon","short","bottom")}))}else if(1==t.index){if(void 0==e.coupon.titolo||0==e.coupon.titolo.length)return void a.alert({title:"Titolo Coupon",template:"Assegna un titolo"});if(void 0==e.coupon.descrizione||0==e.coupon.descrizione.length)return void a.alert({title:"Descrizione Coupon",template:"Inserisci una descrizione"});if(void 0==e.coupon.condizioni_legali||0==e.coupon.condizioni_legali.length)return void a.alert({title:"Condizioni Coupon",template:"Specifica le condizioni di utilizzo"})}}),e.changeDate=function(){var o=new Date,t=new Date(o.getFullYear(),o.getMonth(),o.getDate()),i={date:new Date,mode:"date",minDate:ionic.Platform.isAndroid()?t.getTime():t,allowOldDates:!1,is24Hour:!0,allowFutureDates:!0,doneButtonLabel:"OK",doneButtonColor:"#2ECC71",cancelButtonLabel:"Annulla",cancelButtonColor:"#CC0000"};n.show(i).then(function(o){var n=new Date(o);n.setHours(n.getHours()-Math.floor(n.getTimezoneOffset()/60)),e.coupon.data_inizio_erogazione=n,e.changeDuration()})},e.changeDuration=function(){e.coupon.data_fine_erogazione=p.scadenza_coupon(e.coupon.data_inizio_erogazione,e.coupon.durata_coupon),e.isAvailableDate=!1,d=!0,e.couponForm.$dirty=!0},e.takePhoto=function(){var o={quality:100,correctOrientation:!0,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:1e3,targetHeight:760,saveToPhotoAlbum:!0};p.useCamera(o).then(function(o){e.coupon.filename=o,d=!0,e.couponForm.$dirty=!0},function(){e.couponForm.$dirty=d})},e.getPhotoAlbum=function(){var o={quality:100,correctOrientation:!0,mediaType:Camera.MediaType.PICTURE,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG,targetWidth:1e3,targetHeight:760};p.useCamera(o).then(function(o){e.coupon.filename=o,d=!0,e.couponForm.$dirty=!0},function(){e.couponForm.$dirty=d})},e.removePhoto=function(){u(function(){e.coupon.filename=s.filename.replace("/lg_","/xl_"),d=!0,e.couponForm.$dirty=!0},0)},e.create=function(o){r.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),p.create(o).then(function(){e.couponForm.$dirty=!1,r.hide(),c.goBack(-2),i.show("Coupon creato con successo","short","bottom")},function(){r.hide(),i.show("Errore creazione coupon","short","bottom")})}}]).controller("CouponOperationCtrl",["$rootScope","$scope","$stateParams","$cordovaDatePicker","$cordovaCamera","$cordovaToast","$ionicPopup","$ionicLoading","$ionicHistory","$timeout","Auth","Coupon",function(o,e,n,t,i,a,r,c,u,l,p,s){var d=p.getUserData(null);e.social=d.wmc_data.social,e.notifiche={messaggi:d.wmc_data.messaggi,app:d.wmc_data.app},e.notifiche_checkbox={email:0,sms:0},e.coupon=s.get(n.id);var m=angular.copy(e.coupon);e.isAvailableDate=!0;var h=!1;e.coupon.data_inizio_erogazione=new Date(e.coupon.data_inizio_erogazione).getTime(),e.coupon.numero_coupon_erogabili=parseInt(e.coupon.numero_coupon_erogabili),e.coupon.coupon_illimitati="1"==e.coupon.coupon_illimitati?!0:!1;var g=angular.copy(e.coupon);e.$on("wizard:StepFailed",function(n,t){if(0==t.index){if((void 0==e.coupon.numero_coupon_erogabili||0==e.coupon.numero_coupon_erogabili.length)&&!e.coupon.coupon_illimitati)return void r.alert({title:"Erogazione Coupon",template:"Inserire un numero di quanti coupon possono essere erogati o scegliere l'opzione illimitati"});if(0==e.coupon.sconto.length)return void r.alert({title:"Valore Coupon",template:"Inserire un valore"});e.isAvailableDate||(1!=e.coupon.id_tipologia_stato||1!=e.coupon.active?(c.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),s.checkDate(e.coupon.data_inizio_erogazione,e.coupon.data_fine_erogazione).then(function(n){e.isAvailableDate=n,c.hide(),n?o.$broadcast("wizard:Next"):r.alert({title:"Attenzione",template:"Per le date selezionate &egrave; gi&agrave; presente un altro coupon!"})},function(){c.hide(),a.show("Errore date coupon","short","bottom")})):e.isAvailableDate=!0)}else if(1==t.index){if(0==e.coupon.titolo.length)return void r.alert({title:"Titolo Coupon",template:"Assegna un titolo"});if(0==e.coupon.descrizione.length)return void r.alert({title:"Descrizione Coupon",template:"Inserisci una descrizione"});if(0==e.coupon.condizioni_legali.length)return void r.alert({title:"Condizioni Coupon",template:"Specifica le condizioni di utilizzo"})}}),e.changeDate=function(){var o={date:new Date,mode:"date",minDate:ionic.Platform.isAndroid()?(new Date).getTime():new Date,allowOldDates:!1,is24Hour:!0,allowFutureDates:!0,doneButtonLabel:"OK",doneButtonColor:"#2ECC71",cancelButtonLabel:"Annulla",cancelButtonColor:"#CC0000"};e.coupon.notifiche.pendenti.email||e.coupon.notifiche.pendenti.sms||1==e.coupon.id_tipologia_stato&&1==e.coupon.active||t.show(o).then(function(o){e.coupon.data_inizio_erogazione=new Date(o).getTime(),e.changeDuration()})},e.changeDuration=function(){e.coupon.data_fine_erogazione=s.scadenza_coupon(e.coupon.data_inizio_erogazione,e.coupon.durata_coupon),e.isAvailableDate=!1,h=!0,e.couponOneForm.$dirty=!0},e.changeToggle=function(){h=!0,e.couponOneForm.$dirty=!0},e.isEqual=function(){var o=angular.equals(angular.copy(e.coupon),m);return h=!o,o},e.takePhoto=function(){var o={quality:100,correctOrientation:!0,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:750,targetHeight:570,saveToPhotoAlbum:!0};s.useCamera(o).then(function(o){e.coupon.filename=o,h=!0,e.couponTwoForm.$dirty=!0},function(){})},e.getPhotoAlbum=function(){var o={quality:100,correctOrientation:!0,mediaType:Camera.MediaType.PICTURE,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG,targetWidth:750,targetHeight:570};s.useCamera(o).then(function(o){e.coupon.filename=o,h=!0,e.couponTwoForm.$dirty=!0},function(){})},e.removePhoto=function(){l(function(){e.coupon.filename="http://files.overplace.com/bacheca/xl_overplace.png",h=!0,e.couponTwoForm.$dirty=!0},0)},e.update=function(o){c.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1});var n=o.filename!=g.filename?!0:!1;s.update(o,n).then(function(){e.couponOneForm.$dirty=!1,e.couponTwoForm.$dirty=!1,e.couponThreeForm.$dirty=!1,c.hide(),u.goBack(-2),a.show("Coupon modificato con successo","short","bottom")},function(){c.hide(),a.show("Errore modifica coupon","short","bottom")})}}]);