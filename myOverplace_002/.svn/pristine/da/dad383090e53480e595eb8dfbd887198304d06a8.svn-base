angular.module("starter.controllers",[]).run(["$ionicPlatform","$cordovaPush",function(e,i){var o=null;ionic.Platform.isAndroid()?o={senderID:"751872435382"}:ionic.Platform.isIOS()&&(o={badge:"true",sound:"true",alert:"true"});var t=window.localStorage.getItem("id_scheda");null!==t&&e.ready(function(){i.register(o).then(function(e){ionic.Platform.isIOS()&&(regId=e,window.localStorage.regId=regId)},function(){alert("Errore di connessione")})})}]).controller("AppCtrl",["$rootScope","$scope","$timeout","$state","$ionicLoading","$ionicPopup","$cordovaNetwork","$cordovaLocalNotification","$cordovaMedia","$cordovaVibration","$cordovaToast","$ionicHistory","$cordovaInAppBrowser","Auth","PushState","Chats","Convalide","Notifiche","News","NavBadges",function(e,i,o,t,a,n,c,s,l,r,p,d,h,v,f,u,m,b,g,w){var k=window.localStorage.getItem("id_scheda");null!==k&&(m.getList(),u.init(),u.all().then(function(i){e.NRchats=i}),ionic.Platform.ready(function(){v.checkStatus(k).then(function(e){var i=v.getUserData(),o=!1,c=new Date;for(var s in e)(void 0===i[s]||JSON.stringify(i[s])!=JSON.stringify(e[s]))&&(o=!0);if(c.toISOString()>=e.data_scadenza_app&&"3"==e.id_tipologia_versione_app||"1"==e.app_scaduta&&"3"==e.id_tipologia_versione_app){var l=n.alert({title:"Attenzione",template:"La versione dell'app Ã¨ scaduta!"});l.then(function(){a.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),v.logout().then(function(){v.changeAppVersion(k,"base").then(function(){a.hide(),t.go("login"),d.clearCache(),d.clearHistory()})},function(){a.hide()})})}else o&&(v.storeAuthInfo(e),v.clearCache(),d.clearHistory(),d.clearCache(),window.location.reload())},function(){})})),e.$watch("NRchats",function(e){var i=0;for(var o in e)e[o].toRead&&("#/app/chat/"+e[o].channelReference!==window.location.hash?i++:e[o].toRead=!1);w.setBadges("chat",i)},function(){}),e.$on("$cordovaLocalNotification:click",function(){t.go("app.chat")}),e.$on("$cordovaNetwork:online",function(){window.localStorage.network="online",u.init(),u.all(),e.$broadcast("reInitChat")}),e.$on("$cordovaNetwork:offline",function(){window.localStorage.network="offline",p.show("Nessuna connessione dati","short","bottom")}),i.notifications=[],i.$on("$cordovaPush:notificationReceived",function(i,n){function c(){t.current.name!==s&&""!==s&&o(function(){d.nextViewOptions({disableBack:!0}),t.go(s)})}d.viewHistory(),d.currentView();if(ionic.Platform.isIOS())if(a.hide(),"message"==n.event){var s="";void 0!==n.idRif&&f.getFromRifId(n.idRif).then(function(i){var o=!0;if(i=f.getReference(),void 0!==i.chats&&(o=!1),void 0!==i.chats&&"0"==n.foreground&&(u.addChat(i.chats),u.init(),u.all().then(function(i){e.NRchats=i}),""==s&&(s="app.chat")),void 0!==i.convalide&&(m.getList(),m.addConvalida(i.convalide),""==s&&(s="app.convalide")),void 0!==i.notifiche&&(b.addNotifica(i.notifiche),""==s&&(s="app.notifiche")),"1"==n.foreground&&o){if(n.sound){var t=l.newMedia("/sound/notification.mp3");t.setVolume(.3),t.play()}n.vibrate&&r.vibrate(500)}f.serverNotificationsCallback(),c()})}else p.show("error"==n.event?n.msg+" Push notification error event":"Push notification handler - Unprocessed Event")}),i.openInBrowser=function(e,i,o){var t=v.getUserData(null),a="";switch(i){case"news":a="#box-post";break;case"evento":a="#box-eventi";break;case"coupon":a="#box-coupon";break;case"promozione":a="#box-offerte"}"overplace"==o&&void 0!==t.url_vetrina?h.open(t.url_vetrina+a,"_system"):"facebook"==o&&void 0!==t.pagina_facebook&&"1"==e.facebook&&""!=e.id_post_facebook?h.open(t.pagina_facebook+"/posts/"+e.id_post_facebook,"_system"):"twitter"==o&&void 0!==t.pagina_twitter&&"1"==e.twitter&&""!=e.id_post_twitter&&h.open(t.pagina_twitter+"/status/"+e.id_post_twitter,"_system")}}]).controller("NavMenuCtrl",["$scope","$state","$cordovaToast","Auth","NavBadges",function(e,i,o,t,a){var n=t.getUserData(null);e.badges=a.getBadges(),e.titolo=n.titolo_scheda,e.chat_disabled="0"==n.wmc_data.chat?!0:!1,e.showModuliInattivi="true"==window.localStorage.showModuliInattivi;var c=n.id_tipologia_versione_app;switch(c){case"2":e.menu_version="professional",e.menu_professional=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"news",name:"News",link:"#/app/news",icon:"fa-quote-left",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"eventi",name:"Eventi",link:"#/app/eventi",icon:"fa-bullhorn",type:"simple",section:1,order:5,active:!0,visible:!0},{id:"promozioni",name:"Promozioni",link:"#/app/promozioni",icon:"fa-trophy",type:"simple",section:1,order:6,active:n.wmc_data.promozioni,visible:!0},{id:"coupon",name:"Coupon",link:"#/app/coupon",icon:"fa-gavel",type:"simple",section:1,order:7,active:n.wmc_data.coupon,visible:!0},{id:"recensioni",name:"Recensioni",link:"#/app/recensioni",icon:"fa-commenting-o",type:"simple",section:1,order:8,active:!0,visible:!0},{id:"gallery",name:"Gallery",link:"#/app/gallery",icon:"fa-picture-o",type:"simple",section:1,order:9,active:!0,visible:!0},{id:"riepilogo",name:"Report",link:"#/app/riepilogo",icon:"fa-line-chart",type:"simple",section:1,order:10,active:!0,visible:!0},{id:"help",name:"Help",link:"#/app/help",icon:"fa-question",type:"simple",section:2,order:0,active:!0,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0}];break;case"3":e.menu_version="trial";var s="1"==n.app_scaduta?!0:!1;e.data_scadenza_app=n.data_scadenza_app,s?(e.menu_version="base",e.menu_base=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}]):e.menu_trial={base:[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}],professional:[{id:"news",name:"News",link:"#/app/news",icon:"fa-quote-left",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"eventi",name:"Eventi",link:"#/app/eventi",icon:"fa-bullhorn",type:"simple",section:1,order:5,active:!0,visible:!0},{id:"promozioni",name:"Promozioni",link:"#/app/promozioni",icon:"fa-trophy",type:"simple",section:1,order:6,active:n.wmc_data.promozioni,visible:!0},{id:"coupon",name:"Coupon",link:"#/app/coupon",icon:"fa-gavel",type:"simple",section:1,order:7,active:n.wmc_data.coupon,visible:!0},{id:"recensioni",name:"Recensioni",link:"#/app/recensioni",icon:"fa-commenting-o",type:"simple",section:1,order:8,active:!0,visible:!0},{id:"gallery",name:"Gallery",link:"#/app/gallery",icon:"fa-picture-o",type:"simple",section:1,order:9,active:!0,visible:!0},{id:"riepilogo",name:"Report",link:"#/app/riepilogo",icon:"fa-line-chart",type:"simple",section:1,order:10,active:!0,visible:!0},{id:"help",name:"Help",link:"#/app/help",icon:"fa-question",type:"simple",section:2,order:0,active:!0,visible:!0}]};break;default:e.menu_version="base",e.menu_base=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}]}e.showModuliChange=function(){e.showModuliInattivi=1==e.showModuliInattivi?!1:!0;var i=1==e.showModuliInattivi?"Moduli ripristinati":"Moduli nascosti";window.localStorage.showModuliInattivi=e.showModuliInattivi,o.show(i,"short","bottom")}}]).controller("HomeCtrl",["$scope","$state","$ionicLoading","$ionicHistory","$cordovaNetwork","$cordovaToast","$timeout","Auth","PushState","Chats","NavBadges",function(e,i,o,t,a,n,c,s,l,r,p){var d=s.getUserData(null);e.badges=p.getBadges(),e.titolo=d.titolo_scheda,e.username=d.nome_utente,c(function(){e.filename=d.filepath,void 0===cordova.file&&(e.filename=d.filename)},10),e.chat_disabled="0"==d.wmc_data.chat?!0:!1,e.menu_home_list=[{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:d.wmc_data.chat,visible:!0}],e.settings={enablePushNotifications:"true"===window.localStorage.enablePushNotifications?!0:!1,chatAvailable:"false"===window.localStorage.chatAvailable?!1:!0},e.chatAvailableChange=function(){l.toggleChat(e.settings.chatAvailable).then(function(){window.localStorage.chatAvailable=e.settings.chatAvailable;var i=e.settings.chatAvailable===!0?"Chat attivata":"Chat disattivata";n.show(i,"short","bottom"),e.settings.chatAvailable===!1?r.breakChat():(r.init(),r.all(),t.clearCache(),t.clearHistory())},function(){n.show("Errore cambio stato Chat","short","bottom")})},e.pushNotificationChange=function(){if(e.settings.enablePushNotifications){var i={id_scheda:window.localStorage.id_scheda};l.register(i).then(function(){e.settings.enablePushNotifications=!0,n.show("Notifiche attivate","short","bottom")},function(){e.settings.enablePushNotifications=!1,n.show("Errore attivazione notifiche","short","bottom")})}else l.unregister().then(function(){e.settings.enablePushNotifications=!1,n.show("Notifiche disattivate","short","bottom")},function(){e.settings.enablePushNotifications=!0,n.show("Errore disattivazione notifiche","short","bottom")});window.localStorage.enablePushNotifications=e.settings.enablePushNotifications},e.logout_disabled="online"==window.localStorage.network?!1:!0,e.$watch(function(){return window.localStorage.network},function(i,o){void 0!==i&&i!=o&&(e.logout_disabled="online"==i?!1:!0)}),e.logout=function(){return a.isOffline()?(n.show("Nessuna connessione dati","short","bottom"),!1):(o.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),void s.logout().then(function(){o.hide(),i.go("login"),t.clearCache(),t.clearHistory()},function(){o.hide()}))}}]).controller("LoginCtrl",["$scope","$rootScope","$ionicLoading","$cordovaNetwork","$cordovaToast","$state","Auth","Convalide","Chats","NavBadges",function(e,i,o,t,a,n,c,s,l){e.credentials={username:"",password:""},e.auth_error=null,e.submitted=!1,e.login_disabled=!1,e.$watch(function(){return window.localStorage.network},function(i,o){void 0!==i&&i!=o&&(e.login_disabled="online"==i?!1:!0)}),e.login=function(){if(e.loginForm.$valid){if(cordova.plugins.Keyboard.isVisible&&cordova.plugins.Keyboard.close(),window.localStorage.network=t.isOnline()?"online":"offline",t.isOffline())return a.show("Nessuna connessione dati","short","bottom"),!1;o.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),c.login(e.credentials.username,e.credentials.password).then(function(t){e.auth_error=!1,c.storeAuthInfo(t.data),s.refreshList(),l.init(),l.all().then(function(e){i.NRchats=e}),o.hide(),n.go("app.home",{},{reload:!0})},function(){e.auth_error=!0,o.hide(),a.show("Indirizzo email o password errati","short","center")})}else e.login_form.submitted=!0}}]).controller("ContattiCtrl",["$scope","Auth",function(e,i){var o=i.getUserData("support");e.isSupport=Object.keys(o).length>0,e.isSupport&&(e.support_phone=void 0!==o.phone&&null!==o.phone&&o.phone.length>0?o.phone:null,e.support_email=void 0!==o.email&&null!==o.email&&o.email.length>0?o.email:null)}]);