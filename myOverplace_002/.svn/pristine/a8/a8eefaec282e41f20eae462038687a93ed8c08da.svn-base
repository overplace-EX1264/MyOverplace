angular.module("recensioni.services",[]).factory("Recensioni",["$http","$q","$cordovaToast","$ionicPopup","ApiConfig","Cache",function(e,i,n,r,o,c){var t=this;return t.page=1,t.more=!0,c.recensioniCache=[],c.recensioniCacheId={},t.moreList=function(){var n=i.defer(),r={},a=o.ovpEndpoint+"commenti/"+window.localStorage.id_scheda+"/"+t.page+"/fields";return r[o.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:a,params:r,cache:!1}).success(function(e){for(var i=[],r=e.commenti,o=e.commenti.length,a=0;o>a;a++){if(c.recensioniCacheId.hasOwnProperty(r[a].id)){var s=angular.extend({},c.recensioniCacheId[r[a].id]),d=angular.extend({},r[a]);if(delete s.$$hashKey,delete d.$$hashKey,!equals(s,d,!1)){var h=c.recensioniCache.indexOf(c.recensioniCacheId[r[a].id]);c.recensioniCache[h]=r[a],c.recensioniCacheId[r[a].id]=r[a]}}else c.recensioniCacheId[r[a].id]=r[a],c.recensioniCache.push(r[a]);i.push(r[a].id)}if(1==t.page)for(var p in c.recensioniCacheId)-1==i.indexOf(p)&&(c.recensioniCache.splice(c.recensioniCache.indexOf(c.recensioniCacheId[p]),1),delete c.recensioniCacheId[p]);t.more=e.more,n.resolve(c.recensioniCache)}).error(function(){n.reject()}),n.promise},{refreshList:function(){t.page=1;var e=i.defer();return t.moreList().then(function(i){e.resolve(i)},function(){e.reject()}),e.promise},loadMore:function(){return void 0!==c.recensioniCache&&Object.keys(c.recensioniCache).length>0?(t.page++,t.moreList()):(t.page=1,t.moreList())},getMoreStatus:function(){return void 0==t.more?!1:t.more},getList:function(){return void 0!==c.recensioniCache&&Object.keys(c.recensioniCache).length>0?c.recensioniCache:this.refreshList()},get:function(e){return c.recensioniCacheId[e]},reply:function(n,r){var t=i.defer(),a=o.ovpEndpointHmac+"app/post/commenti_risposta/"+window.localStorage.id_scheda,s={operation:"create",id_padre:n.id,commento:r};return e({method:"POST",url:a,data:JSON.stringify(s).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){if(0!=e.hasOwnProperty("error"))t.reject();else{var i=c.recensioniCache.indexOf(c.recensioniCacheId[n.id]),o={id:e.id,commento:r,id_tipologia_stato:e.id_tipologia_stato,timestamp:e.timestamp};c.recensioniCache[i].risposta=o,c.recensioniCacheId[n.id].risposta=o,t.resolve(o)}}).error(function(){t.reject()}),t.promise}}}]);