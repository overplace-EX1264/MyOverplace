angular.module("chat.services",[]).factory("Chats",["$http","$cordovaLocalNotification","$cordovaToast","$cordovaMedia","ApiConfig","NavBadges","Cache","$pusher","$rootScope","$timeout","$q",function(e,n,a,i,t,s,o,r,h,c,l){var d,u=this,_=!1;this.pusherChat=function(e){if(void 0===window.localStorage.chatAvailable||"true"!==window.localStorage.chatAvailable||"0"==window.localStorage.chat)return d.disconnect(),!1;var n=this;this._pusher=e,this._chatChannel=[],this._messagesData={},this._chats=[],this._chatsName=[],this._conversazioni=[],this._heartBeat,this._storageConversazioni=[],this._liveChannels=[],this._userList=[],this._orphanChannels=[],this._unsubscribePending=[],this._myUserID,this.sender="user";var a=e.subscribe("presence-"+window.localStorage.id_scheda),i=e.subscribe("private-chat-"+window.localStorage.id_scheda);a.bind("pusher:subscription_succeeded",function(e){if(n._storageConversazioni=void 0!==window.localStorage.storageConversazioni?JSON.parse(window.localStorage.storageConversazioni):[],n._myUserID=e.me.id,e.count>1)for(var a in e.members)if(a!==e.me.id){var t="private-ovp-chat-"+window.localStorage.id_scheda+"-"+a,s=n._orphanChannels.indexOf(t),o=n._unsubscribePending.indexOf(t);s>-1&&n._orphanChannels.splice(s,1),o>-1&&n._unsubscribePending.splice(o,1),void 0===n._chatChannel[t]&&(n._liveChannels.push(t),n.initializeChat(t))}i.bind("ovp-chat-"+window.localStorage.id_scheda,function(e){if(e.chat_with===n._myUserID){var a=n._orphanChannels.indexOf(e.channel_name),i=n._unsubscribePending.indexOf(e.channel_name);a>-1&&n._orphanChannels.splice(a,1),i>-1&&n._unsubscribePending.splice(i,1),void 0===n._chatChannel[e.channel_name]&&(n._liveChannels.push(e.channel_name),n.initializeChat(e.channel_name))}});for(var r in n._storageConversazioni)-1===n._liveChannels.indexOf(n._storageConversazioni[r])&&(n._orphanChannels.push(n._storageConversazioni[r]),n.initializeChat(n._storageConversazioni[r]))}),a.bind("pusher:member_removed",function(e){var a="private-ovp-chat-"+window.localStorage.id_scheda+"-"+e.id;n._unsubscribePending.push(a),c(function(){var e=n._unsubscribePending.indexOf(a),i=-1!==n._liveChannels.indexOf(channel);e>-1&&(n._unsubscribePending.splice(e,1),n._pusher.unsubscribe(a),n._orphanChannels.push(a)),i>-1&&n._liveChannels.splice(i,1)},15e3)}),function t(){n._heartBeat=setTimeout(function(){for(var e in n._chatChannel)-1!==n._liveChannels.indexOf(e)&&n._chatChannel[e].trigger("client-esercente-ping",{ping:!0});t()},5e3)}()},this.pusherChat.prototype._unsubscribeChannels=function(){var e=this;if(void 0!==e._pusher&&void 0!==e._pusher.unsubscribe){e._pusher.unsubscribe("presence-"+window.localStorage.id_scheda),e._pusher.unsubscribe("private-chat-"+window.localStorage.id_scheda);for(var n in this._chatChannel){var a=n.split("-")[4];e.resetChannel(n,a),e._pusher.unsubscribe(n)}clearTimeout(e._heartBeat)}},this.pusherChat.prototype._breakChat=function(){var e=this;if(void 0!==e._pusher&&void 0!==e._pusher.unsubscribe){e._pusher.unsubscribe("presence-"+window.localStorage.id_scheda),e._pusher.unsubscribe("private-chat-"+window.localStorage.id_scheda);for(var n in this._chatChannel)e._pusher.unsubscribe(n);clearTimeout(e._heartBeat)}},this.pusherChat.prototype.chatInstances=[],this.pusherChat.prototype.initializeChat=function(e){var n=this;this.chatInstances.push(this),this._chatChannel[e]=this._pusher.subscribe(e),this._chatChannel[e].bind("pusher:subscription_succeeded",function(){if(n._chatChannel[e].trigger("client-esercente-ping",{ping:!0}),void 0!==window.localStorage[e]){var i=JSON.parse(window.localStorage[e]);for(var t in i)n._chatMessageReceived(i[t],!0)}void 0===window.localStorage["chatsPending-"+e]&&(window.localStorage["chatsPending-"+e]=0),n._chatChannel[e].bind("chat_message_"+e,function(e){void 0!==window.localStorage["opened_"+e.channel_name]&&window.localStorage.removeItem("opened_"+e.channel_name),void 0===window.localStorage["chatsPending-"+e.channel_name]?window.localStorage["chatsPending-"+e.channel_name]=0:window.localStorage["chatsPending-"+e.channel_name]++,n._chatMessageReceived(e)}),n._chatChannel[e].bind("pusher:subscription_error",function(){a.show("Impossibile abilitare la chat","long","center")}),n._chatChannel[e].bind("close_"+e,function(){h.$broadcast("chatClosed",e),n._orphanChannels.push(e)})})},this.pusherChat.prototype._chatMessageReceived=function(e,n){if(void 0===this._messagesData[e.channel_name]&&(this._messagesData[e.channel_name]=[]),-1===this._storageConversazioni.indexOf(e.channel_name)&&(this._storageConversazioni.push(e.channel_name),window.localStorage.storageConversazioni=JSON.stringify(this._storageConversazioni)),null==n&&(e.sender=this.sender,"user"==this.sender&&0==window.runningBg)){var a=i.newMedia(cordova.file.applicationDirectory+"www/sound/notification.mp3");a.setVolume(.3),a.play()}var t=this._orphanChannels.indexOf(e.channel_name);t>-1&&this._orphanChannels.splice(t,1),Dt=new Date(Date.parse(e.published)),e.pubHour=("0"+Dt.getHours()).slice(-2)+":"+("0"+Dt.getMinutes()).slice(-2),e.actor.image.url=e.actor.image.url.replace("http:",""),this._messagesData[e.channel_name].push(e),window.localStorage.removeItem(e.channel_name),window.localStorage.setItem(e.channel_name,JSON.stringify(this._messagesData[e.channel_name]));var s=e.channel_name.split("-")[4],o=this._userList.indexOf(s),r=("0"+Dt.getDay()).slice(-2)+"/"+("0"+(Dt.getMonth()+1)).slice(-2)+" "+("0"+Dt.getHours()).slice(-2)+":"+("0"+Dt.getMinutes()).slice(-2),c=new Date,l=new Date((new Date).setDate(c.getDate()-1)),d=("0"+Dt.getDate()).slice(-2)+"/"+("0"+(Dt.getMonth()+1)).slice(-2)+"/"+Dt.getFullYear();if(Dt.toDateString()==c.toDateString()?d=("0"+Dt.getHours()).slice(-2)+":"+("0"+Dt.getMinutes()).slice(-2):Dt.toDateString()==l.toDateString()&&(d="IERI"),-1==o?(this._chats.push({name:e.actor.displayName,avatar:e.actor.image.url,lastDate:r,lastTime:Dt.getTime(),printDate:d,lastMessage:e.body.length>50?e.body.substring(0,35)+"...":e.body,channelReference:e.channel_name,toRead:void 0===window.localStorage["opened_"+e.channel_name]?!0:!1,pending:window.localStorage["chatsPending-"+e.channel_name],userId:s}),this._chatsName[e.channel_name]=e.actor.displayName,this._userList.push(s)):(this._chats[o].lastMessage=e.body.length>35?e.body.substring(0,35)+"...":e.body,this._chats[o].lastDate=r,this._chats[o].lastTime=Dt.getTime(),this._chats[o].printDate=d,this._chats[o].channelReference=e.channel_name,this._chats[o].pending=window.localStorage["chatsPending-"+e.channel_name],this._chats[o].toRead||void 0!==window.localStorage["opened_"+e.channel_name]||"user"!=this.sender||(this._chats[o].toRead=!0)),null==n){var u=-1==o?this._chats.length-1:o,_=this._chats[u];this._chats.splice(u,1),this._chats.unshift(_),this._userList.splice(u,1),this._userList.unshift(s)}this._conversazioni[e.channel_name]=this._messagesData[e.channel_name],void 0!==window.runningBg&&1==window.runningBg&&this.notify(e),h.$broadcast("newMessage",e.channel_name)},this.pusherChat.prototype.resetChannel=function(n,i){var s=this,o={channel:n,operation:"close_chat",closer:"Esercente"},r=t.ovpEndpoint+"chat";o[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:r,params:o}).success(function(){s._pusher.unsubscribe(n),delete s._chatChannel[n],delete s._messagesData[n],window.localStorage.removeItem(n),s._storageConversazioni.splice(s._storageConversazioni.indexOf(n),1),window.localStorage.storageConversazioni=JSON.stringify(s._storageConversazioni),window.localStorage.removeItem("opened_"+n),window.localStorage.removeItem("chatsPending-"+n),s._userList.splice(s._userList.indexOf(i),1),s._liveChannels.splice(s._liveChannels.indexOf(n),1)}).error(function(){a.show("Impossibile chiudere la conversazione, errore di connessione","long","center"),s.sender="user"})},this.pusherChat.prototype.notify=function(e){n.schedule({id:parseInt((new Date).getTime()),title:"Nuovo chat da "+e.actor.displayName,icon:"iconb_large",smallIcon:"ic_notification_50",message:e.body})},this.pusherChat.prototype._sendResponse=function(n,i){var s=this;if(this._orphanChannels.indexOf(i)>-1)return a.show("Utente non connesso","long","center"),void(s.sender="user");this.sender="me";var o={chat_info:JSON.stringify(n),channel:i,id_scheda:window.localStorage.id_scheda,operation:"chat"},r=t.ovpEndpoint+"chat";o[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:r,params:o}).success(function(){s.sender="user"}).error(function(){a.show("Impossibile inviare il messaggio","long","center"),s.sender="user"}).then(function(){s.sender="user",s._chatChannel[i].trigger("client-esercente-ping",{ping:!0})})},this.pusherChat.prototype._resetPending=function(e){window.localStorage["chatsPending-"+e]=0;var n=e.split("-")[4],a=this._userList.indexOf(n);-1!=a&&(this._chats[a].pending=0)};var g={};return{init:function(){if(!_){d=new Pusher("11e7092aade616c4be28",{authTransport:"jsonp",authEndpoint:"http://www.overplace.com/my/esercente_chat_app_auth.php"});var e=r(d);g=new u.pusherChat(e),_=!0}},all:function(){var e=l.defer();return c(function(){e.resolve(g._chats)},1e3),e.promise},remove:function(e){g._chats.splice(g._chats.indexOf(e),1),g.resetChannel(e.channelReference,e.userId)},minusCounter:function(e){window.localStorage["opened_"+e]=!0},get:function(e){return g._resetPending(e),g._conversazioni[e]},getName:function(e){return g._chatsName[e]},sendResponse:function(e,n){return void 0!==g._conversazioni[n]?g._sendResponse(e,n):void 0},resetPending:function(e){g._resetPending(e)},unsubscribeChannels:function(){return g._unsubscribeChannels(),d.disconnect(),_=!1,!0},breakChat:function(){g._breakChat(),d.disconnect(),_=!1},addChat:function(e){for(var n=e.length,a=0;n>a;a++){notifica=e[a];var i=notifica.channel_name,t=void 0!==window.localStorage[i]?JSON.parse(window.localStorage[i]):[];t.push(notifica),window.localStorage[i]=JSON.stringify(t);var s=void 0!==window.localStorage.storageConversazioni?JSON.parse(window.localStorage.storageConversazioni):[];-1===s.indexOf(i)&&(s.push(i),window.localStorage.storageConversazioni=JSON.stringify(s)),void 0===window.localStorage["chatsPending-"+i]?window.localStorage["chatsPending-"+i]=1:window.localStorage["chatsPending-"+i]++}}}}]);