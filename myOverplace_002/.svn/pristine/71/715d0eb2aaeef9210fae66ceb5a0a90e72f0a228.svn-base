angular.module("starter.services",[]).constant("ApiConfig",{wsKey:void 0!==window.localStorage.restPass?window.localStorage.restPass:"mypassword",ovpEndpoint:"http://api.overplace.com/rest/application/",ovpEndpointHmac:"http://api.overplace.com/rest/v1/"}).constant("APP_VERSION",2).constant("Cache",{convalideCache:[],convalideCacheAll:[],convalideCacheId:{},convalideRemovedCache:[],notificheCache:[],notificheCacheId:{},notificheCacheRead:{}}).factory("NavBadges",["$http",function(){var e={};return e.badges={notifiche:0,convalide:0,chat:0},e.setBadges=function(r,n){e.badges[r]=window.localStorage["nr_"+r]=n},e.getBadges=function(){return e.badges},e}]).factory("Auth",["$http","$q","$cordovaFileTransfer","$cordovaFile","ApiConfig","PushState","Chats","Cache","APP_VERSION",function(e,r,n,o,t,a,c,i,s){var l=this,d=null!==window.localStorage.getItem("user")?JSON.parse(window.localStorage.user):{};return this.clearLocalStorage=function(){window.localStorage.clear()},{login:function(o,c){var i=r.defer(),s={username:o,password:c};return s[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:t.ovpEndpoint+"login",params:s,cache:!1}).success(function(e){var r=e.filename,o=r.split("/").pop(),t=cordova.file.dataDirectory+o,c=!0,s={};e.filepath=t,n.download(r,t,s,c).then(function(){a.register(e).then(function(){return i.resolve(e)},function(){return i.reject()})},function(){return i.reject()})}).error(function(){return i.reject()})},logout:function(){var e=r.defer();return a.unregister().then(function(r){return l.clearLocalStorage(),c.unsubscribeChannels(),i.convalideCache=[],i.convalideCacheAll=[],i.convalideCacheId={},i.convalideRemovedCache=[],i.notificheCache=[],i.notificheCacheId={},i.notificheCacheRead={},i.newsCache=[],i.newsCacheId={},e.resolve(r)},function(){return e.reject()})},storeAuthInfo:function(e){window.localStorage.APP_VERSION=s,window.localStorage.id_scheda=e.id_scheda,window.localStorage.user=JSON.stringify(e),window.localStorage.enablePushNotifications=!0,window.localStorage.showModuliInattivi=!0,window.localStorage.chatAvailable="1"==e.wmc_data.chat?!0:!1,d=e},checkStatus:function(o){var a=r.defer(),c={};return c[t.wsKey]="JSON_CALLBACK",c.nocache=(new Date).getTime(),e({method:"JSONP",url:t.ovpEndpoint+"permessi-app/"+o,params:c,cache:!1}).success(function(e){if(d.filename!=e.filename){var r=e.filename,o=r.split("/").pop(),t=cordova.file.dataDirectory+o,c=!0,i={};e.filepath=t,n.download(r,t,i,c).then(function(){a.resolve(e)},function(){a.reject()})}else e.filepath=d.filepath,a.resolve(e)}).error(function(){a.reject()}),a.promise},changeAppVersion:function(n,o){var a=r.defer(),c=t.ovpEndpointHmac+"post/change-app-version/"+n,i={version:o};return e({method:"POST",url:c,data:JSON.stringify(i).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?a.reject():a.resolve(e)}).error(function(){a.reject()}),a.promise},clearCache:function(){return c.unsubscribeChannels(),i.convalideCache=[],i.convalideCacheAll=[],i.convalideCacheId={},i.convalideRemovedCache=[],i.notificheCache=[],i.notificheCacheId={},i.notificheCacheRead={},i.newsCache=[],i.newsCacheId={},!0},getUserData:function(e){return null!=e?d.hasOwnProperty(e)?d[e]:{}:d}}}]).factory("PushState",["$http","$q","$cordovaPush","$cordovaDevice","ApiConfig",function(e,r,n,o,t){var a=this,c=null,i=null,s=null;return ionic.Platform.isAndroid()?c={senderID:"751872435382"}:ionic.Platform.isIOS()&&(c={badge:"true",sound:"true",alert:"true"}),this.storeDeviceToken=function(n){s=window.localStorage.id_scheda,i=window.localStorage.regId;var a=r.defer(),c={regid:i,uuid:o.getUUID(),so_type:o.getPlatform()};return c[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:t.ovpEndpoint+"reg/"+s+"/"+n+"/fields",params:c,cache:!1}).success(function(e){return a.resolve(e)}).error(function(){return a.reject()})},{register:function(e){var o=r.defer();return s=e.id_scheda,n.register(c).then(function(e){return ionic.Platform.isIOS()&&(i=e,window.localStorage.regId=i,a.storeDeviceToken("registration")),o.resolve(e)},function(){return o.reject()})},unregister:function(){var e=r.defer();return a.storeDeviceToken("unregistration").then(function(r){return e.resolve(r)},function(){return e.reject()})},handleAndroid:function(e){var n=r.defer();return i=e.regid,window.localStorage.regId=i,s=window.localStorage.id_scheda,a.storeDeviceToken("registration").then(function(e){return n.resolve(e)},function(){return n.reject()})},handleIOS:function(e){var n=r.defer();return i=e,window.localStorage.regId=i,s=window.localStorage.id_scheda,a.storeDeviceToken("registration").then(function(e){return n.resolve(e)},function(){return n.reject()})},serverNotificationsCallback:function(){var r={regid:window.localStorage.regId},n=t.ovpEndpoint+"notification/cb/"+window.localStorage.id_scheda+"/fields";r[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:n,params:r,cache:!1}).success(function(){}).error(function(){}).then(function(){})},toggleChat:function(e){var n=r.defer();i=window.localStorage.regId;var o=e===!0?"enable_chat":"disable_chat";return a.storeDeviceToken(o).then(function(e){return n.resolve(e)},function(){return n.reject()})},getFromRifId:function(n){var o=r.defer(),c={refId:n},i=t.ovpEndpoint+"notification/get/"+window.localStorage.id_scheda+"/fields";return c[t.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:i,params:c,cache:!1}).success(function(e){return a.reference=e,o.resolve(e)}).error(function(){return o.reject()})},getReference:function(){return a.reference}}}]).factory("ListeContatti",["$http","$q","ApiConfig",function(e,r,n){return{getByType:function(o){var t=r.defer(),a=n.ovpEndpoint+"liste_contatti/"+window.localStorage.id_scheda+"/"+o+"/fields",c={};return c[n.wsKey]="JSON_CALLBACK",e({method:"JSONP",url:a,params:c,cache:!1}).success(function(e){0!=e.hasOwnProperty("error")?t.reject(e.error):t.resolve(e)}).error(function(){t.reject()}),t.promise}}}]);