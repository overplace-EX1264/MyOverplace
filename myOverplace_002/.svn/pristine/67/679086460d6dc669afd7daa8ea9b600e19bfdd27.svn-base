angular.module("starter.services",[]).constant("ApiConfig",{wsKey:void 0!==window.localStorage.restPass?window.localStorage.restPass:"mypassword",ovpEndpoint:"http://api.overplace.com/rest/application/",ovpEndpointHmac:"http://api.overplace.com/rest/v1/"}).constant("APP_VERSION",2).constant("Cache",{convalideCache:[],convalideCacheAll:[],convalideCacheId:{},convalideRemovedCache:[],notificheCache:[],notificheCacheId:{},notificheCacheRead:{}}).factory("NavBadges",["$http",function(){var e={};return e.badges={notifiche:0,convalide:0,chat:0},e.setBadges=function(n,r){e.badges[n]=window.localStorage["nr_"+n]=r},e.getBadges=function(){return e.badges},e}]).factory("Auth",["$http","$q","$cordovaFileTransfer","$cordovaFile","ApiConfig","PushState","Chats","Cache","APP_VERSION",function(e,n,r,t,o,a,c,i,l){var s=this,d=null!==window.localStorage.getItem("user")?JSON.parse(window.localStorage.user):{};return this.clearLocalStorage=function(){window.localStorage.clear()},{clearStorage:function(){return s.clearLocalStorage(),!0},login:function(t,c){var i=n.defer(),l=o.ovpEndpointHmac+"login",s={username:t,password:c,app_type:"myOverplace"};return s.nocache=(new Date).getTime(),e({method:"POST",url:l,data:JSON.stringify(s).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){var n=e.filename,t=n.split("/").pop(),o=cordova.file.dataDirectory+t,c=!0,l={};e.filepath=o,r.download(n,o,l,c).then(function(){a.register(e).then(function(){return i.resolve(e)},function(){return i.reject()})},function(){return i.reject()})}).error(function(){return i.reject()})},logout:function(){var e=n.defer();return a.unregister().then(function(n){return s.clearLocalStorage(),c.unsubscribeChannels(),i.convalideCache=[],i.convalideCacheAll=[],i.convalideCacheId={},i.convalideRemovedCache=[],i.notificheCache=[],i.notificheCacheId={},i.notificheCacheRead={},i.newsCache=[],i.newsCacheId={},e.resolve(n)},function(){return e.reject()})},storeAuthInfo:function(e){window.localStorage.APP_VERSION=l,window.localStorage.id_scheda=e.id_scheda,window.localStorage.user=JSON.stringify(e),window.localStorage.enablePushNotifications=!0,window.localStorage.showModuliInattivi=!0,window.localStorage.chatAvailable="1"==e.wmc_data.chat?!0:!1,d=e},checkStatus:function(t){var a=n.defer(),c={};return c[o.wsKey]="JSON_CALLBACK",c.nocache=(new Date).getTime(),e({method:"JSONP",url:o.ovpEndpoint+"permessi-app/"+t,params:c,cache:!1}).success(function(e){if(d.filename!=e.filename){var n=e.filename,t=n.split("/").pop(),o=cordova.file.dataDirectory+t,c=!0,i={};e.filepath=o,r.download(n,o,i,c).then(function(){a.resolve(e)},function(){a.reject()})}else e.filepath=d.filepath,a.resolve(e)}).error(function(){a.reject()}),a.promise},changeAppVersion:function(r,t){var a=n.defer(),c=o.ovpEndpointHmac+"post/change-app-version/"+r,i={version:t};return e({method:"POST",url:c,data:JSON.stringify(i).replace(/\//g,"\\/"),cache:!1,hmac:!0}).success(function(e){0!=e.hasOwnProperty("error")?a.reject():a.resolve(e)}).error(function(){a.reject()}),a.promise},clearCache:function(){return c.unsubscribeChannels(),i.convalideCache=[],i.convalideCacheAll=[],i.convalideCacheId={},i.convalideRemovedCache=[],i.notificheCache=[],i.notificheCacheId={},i.notificheCacheRead={},i.newsCache=[],i.newsCacheId={},!0},getUserData:function(e){return null!=e?d.hasOwnProperty(e)?d[e]:{}:d}}}]).factory("PushState",["$http","$q","$cordovaPush","$cordovaDevice","ApiConfig",function(e,n,r,t,o){var a=this,c=null,i=null,l=null;return ionic.Platform.isAndroid()?c={senderID:"751872435382"}:ionic.Platform.isIOS()&&(c={badge:"true",sound:"true",alert:"true"}),this.storeDeviceToken=function(r){l=window.localStorage.id_scheda,i=window.localStorage.regId;var a=n.defer(),c={regid:i,uuid:t.getUUID(),so_type:t.getPlatform(),app_type:"myOverplace"};return c[o.wsKey]="JSON_CALLBACK",c.nocache=(new Date).getTime(),e({method:"JSONP",url:o.ovpEndpoint+"reg/"+l+"/"+r+"/fields",params:c,cache:!1}).success(function(e){return a.resolve(e)}).error(function(){return a.reject()})},{register:function(e){var t=n.defer();return l=e.id_scheda,r.register(c).then(function(e){return ionic.Platform.isIOS()&&(i=e,window.localStorage.regId=i,a.storeDeviceToken("registration")),t.resolve(e)},function(){return t.reject()})},unregister:function(){var e=n.defer();return a.storeDeviceToken("unregistration").then(function(n){return e.resolve(n)},function(){return e.reject()})},handleAndroid:function(e){var r=n.defer();return i=e.regid,window.localStorage.regId=i,l=window.localStorage.id_scheda,a.storeDeviceToken("registration").then(function(e){return r.resolve(e)},function(){return r.reject()})},handleIOS:function(){return null},serverNotificationsCallback:function(){var n={regid:window.localStorage.regId},r=o.ovpEndpoint+"notification/cb/"+window.localStorage.id_scheda+"/fields";n[o.wsKey]="JSON_CALLBACK",n.nocache=(new Date).getTime(),e({method:"JSONP",url:r,params:n,cache:!1}).success(function(){}).error(function(){}).then(function(){})},toggleChat:function(e){var r=n.defer();i=window.localStorage.regId;var t=e===!0?"enable_chat":"disable_chat";return a.storeDeviceToken(t).then(function(e){return r.resolve(e)},function(){return r.reject()})},getFromRifId:function(r){var t=n.defer(),c={refId:r},i=o.ovpEndpoint+"notification/get/"+window.localStorage.id_scheda+"/fields";return c[o.wsKey]="JSON_CALLBACK",c.nocache=(new Date).getTime(),e({method:"JSONP",url:i,params:c,cache:!1}).success(function(e){return a.reference=e,t.resolve(e)}).error(function(){return t.reject()})},getReference:function(){return a.reference}}}]).factory("ListeContatti",["$http","$q","ApiConfig",function(e,n,r){return{getByType:function(t){var o=n.defer(),a=r.ovpEndpoint+"liste_contatti/"+window.localStorage.id_scheda+"/"+t+"/fields",c={};return c[r.wsKey]="JSON_CALLBACK",c.nocache=(new Date).getTime(),e({method:"JSONP",url:a,params:c,cache:!1}).success(function(e){0!=e.hasOwnProperty("error")?o.reject(e.error):o.resolve(e)}).error(function(){o.reject()}),o.promise}}}]);