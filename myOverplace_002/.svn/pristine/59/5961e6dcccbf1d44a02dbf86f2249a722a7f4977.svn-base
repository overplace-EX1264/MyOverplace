angular.module("starter.controllers",[]).run(["$ionicPlatform","$cordovaPush","Database",function(e,i,a){var o,t=null;window.database={_queue:[],_flushQueue:function(){window.database._queue.length>0&&window.database.mSQLite.transaction(function(e){for(var i=0;i<window.database._queue.length;i++)"object"==typeof window.database._queue[i].sql?e.executeSql(window.database._queue[i].sql.query,window.database._queue[i].sql.params,window.database._queue[i].callback):e.executeSql(window.database._queue[i].sql,[],window.database._queue[i].callback)},function(){},function(){window.database._queue=new Array})},isReady:!1,isOpen:!1,mSQLite:null,addQueue:function(e,i){return"string"!=typeof e&&"object"!=typeof e||"function"!=typeof i?!1:"object"!=typeof e||e.hasOwnProperty("query")&&e.hasOwnProperty("params")&&"string"==typeof e.query&&"object"==typeof e.params?(window.database._queue.push({sql:e,callback:i}),window.database._queue.length-1):!1},getResult:function(e){return void 0!=typeof window.database._results[e]?window.database._results[e]:null},open:function(){window.database.close(),a.open("database.db",function(e){window.database.isOpen=!0,window.database.mSQLite=e;var i="CREATE TABLE IF NOT EXISTS auth ('id' INT(11) NOT NULL, 'id_scheda' INT(11) NULL,'regid' VARCHAR(255) NULL,'app_type' VARCHAR(50) NULL,'app_version' VARCHAR(50) NULL,'username' VARCHAR(255) NULL,'timestamp' INT(11) NULL,UNIQUE(id));";window.database.isReady=!0,e.transaction(function(e){e.executeSql(i)},function(){},function(){window.database._flushQueue()})})},close:function(){window.database.isOpen?window.database.mSQLite.close(function(){window.database.isOpen=!1,window.database.mSQLite=null}):(window.database.isOpen=!1,window.database.mSQLite=null)}},window.database.open(),ionic.Platform.isAndroid()?t={senderID:"751872435382"}:ionic.Platform.isIOS()&&(t={badge:"true",sound:"true",alert:"true"}),o=window.localStorage.getItem("id_scheda"),null!==o&&e.ready(function(){i.register(t).then(function(e){ionic.Platform.isIOS()&&(regId=e,window.localStorage.regId=regId,window.database.isOpen?window.database.mSQLite.transaction(function(e){e.executeSql("INSERT INTO auth SET id = 1, regid = ? ON DUPLICATE KEY UPDATE auth SET regid = ?;",[regId,regId],function(){})},function(){},function(){}):window.database.addQueue({query:"INSERT INTO auth SET id = 1, regid = ? ON DUPLICATE KEY UPDATE auth SET regid = ?;",params:[regId,regId]},function(){}))},function(){alert("Errore di connessione")})})}]).controller("AppCtrl",["$rootScope","$scope","$timeout","$state","$ionicLoading","$ionicPopup","$cordovaNetwork","$cordovaLocalNotification","$cordovaMedia","$cordovaVibration","$cordovaToast","$ionicHistory","$cordovaInAppBrowser","Auth","PushState","Chats","Convalide","Notifiche","News","NavBadges",function(e,i,a,o,t,n,s,c,r,l,d,p,u,h,m,f,v,w,b,g){var _=window.localStorage.getItem("id_scheda");null!==_&&(v.getList(),f.init(),f.all().then(function(i){e.NRchats=i}),ionic.Platform.ready(function(){h.checkStatus(_).then(function(e){var i=h.getUserData(),a=!1,s=new Date;for(var c in e)(void 0===i[c]||JSON.stringify(i[c])!=JSON.stringify(e[c]))&&(a=!0);if(s.toISOString()>=e.data_scadenza_app&&"3"==e.id_tipologia_versione_app||"1"==e.app_scaduta&&"3"==e.id_tipologia_versione_app){var r=n.alert({title:"Attenzione",template:"La versione dell'app Ã¨ scaduta!"});r.then(function(){t.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),h.logout().then(function(){h.changeAppVersion(_,"base").then(function(){p.clearCache(),p.clearHistory(),t.hide(),o.go("login")})},function(){t.hide()})})}else a&&(h.storeAuthInfo(e),h.clearCache(),p.clearHistory(),p.clearCache(),window.location.reload())},function(){})})),e.$watch("NRchats",function(e){var i=0;for(var a in e)e[a].toRead&&("#/app/chat/"+e[a].channelReference!==window.location.hash?i++:e[a].toRead=!1);g.setBadges("chat",i)},function(){}),e.$on("$cordovaLocalNotification:click",function(){o.go("app.chat")}),e.$on("$cordovaNetwork:online",function(){window.localStorage.network="online",f.init(),f.all(),e.$broadcast("reInitChat")}),e.$on("$cordovaNetwork:offline",function(){window.localStorage.network="offline",d.show("Nessuna connessione dati","short","bottom")}),i.notifications=[],i.$on("$cordovaPush:notificationReceived",function(i,n){function s(){o.current.name!==c&&""!==c&&a(function(){p.nextViewOptions({disableBack:!0}),o.go(c)})}p.viewHistory(),p.currentView();if(ionic.Platform.isIOS())if(t.hide(),"message"==n.event){var c="";void 0!==n.idRif&&m.getFromRifId(n.idRif).then(function(i){var a=!0;if(i=m.getReference(),void 0!==i.chats&&(a=!1),void 0!==i.chats&&"0"==n.foreground&&(f.addChat(i.chats),f.init(),f.all().then(function(i){e.NRchats=i}),""==c&&(c="app.chat")),void 0!==i.convalide&&(v.getList(),v.addConvalida(i.convalide),""==c&&(c="app.convalide")),void 0!==i.notifiche&&(w.addNotifica(i.notifiche),""==c&&(c="app.notifiche")),"1"==n.foreground&&a){if(n.sound){var o=r.newMedia("/sound/notification.mp3");o.setVolume(.3),o.play()}n.vibrate&&l.vibrate(500)}m.serverNotificationsCallback(),s()})}else d.show("error"==n.event?n.msg+" Push notification error event":"Push notification handler - Unprocessed Event")}),i.openInBrowser=function(e,i,a){var o=h.getUserData(null),t="";switch(i){case"news":t="#box-post";break;case"evento":t="#box-eventi";break;case"coupon":t="#box-coupon";break;case"promozione":t="#box-offerte"}"overplace"==a&&void 0!==o.url_vetrina?u.open(o.url_vetrina+t,"_system"):"facebook"==a&&void 0!==o.pagina_facebook&&"1"==e.facebook&&""!=e.id_post_facebook?u.open(o.pagina_facebook+"/posts/"+e.id_post_facebook,"_system"):"twitter"==a&&void 0!==o.pagina_twitter&&"1"==e.twitter&&""!=e.id_post_twitter&&u.open(o.pagina_twitter+"/status/"+e.id_post_twitter,"_system")}}]).controller("NavMenuCtrl",["$scope","$state","$cordovaToast","Auth","NavBadges",function(e,i,a,o,t){var n=o.getUserData(null);e.badges=t.getBadges(),e.titolo=n.titolo_scheda,e.chat_disabled="0"==n.wmc_data.chat?!0:!1,e.showModuliInattivi="true"==window.localStorage.showModuliInattivi;var s=n.id_tipologia_versione_app;switch(s){case"2":e.menu_version="professional",e.menu_professional=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"rubrica",name:"Rubrica",link:"#/app/rubrica",icon:"fa-users",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"news",name:"News",link:"#/app/news",icon:"fa-quote-left",type:"simple",section:1,order:5,active:!0,visible:!0},{id:"eventi",name:"Eventi",link:"#/app/eventi",icon:"fa-bullhorn",type:"simple",section:1,order:6,active:!0,visible:!0},{id:"promozioni",name:"Promozioni",link:"#/app/promozioni",icon:"fa-trophy",type:"simple",section:1,order:7,active:n.wmc_data.promozioni,visible:!0},{id:"coupon",name:"Coupon",link:"#/app/coupon",icon:"fa-gavel",type:"simple",section:1,order:8,active:n.wmc_data.coupon,visible:!0},{id:"recensioni",name:"Recensioni",link:"#/app/recensioni",icon:"fa-commenting-o",type:"simple",section:1,order:9,active:!0,visible:!0},{id:"gallery",name:"Gallery",link:"#/app/gallery",icon:"fa-picture-o",type:"simple",section:1,order:10,active:!0,visible:!0},{id:"riepilogo",name:"Report",link:"#/app/riepilogo",icon:"fa-line-chart",type:"simple",section:1,order:11,active:!0,visible:!0},{id:"help",name:"Help",link:"#/app/help",icon:"fa-question",type:"simple",section:2,order:0,active:!0,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0}];break;case"3":e.menu_version="trial";var c="1"==n.app_scaduta?!0:!1;e.data_scadenza_app=n.data_scadenza_app,c?(e.menu_version="base",e.menu_base=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"rubrica",name:"Rubrica",link:"#/app/rubrica",icon:"fa-users",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}]):e.menu_trial={base:[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"rubrica",name:"Rubrica",link:"#/app/rubrica",icon:"fa-users",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}],professional:[{id:"news",name:"News",link:"#/app/news",icon:"fa-quote-left",type:"simple",section:1,order:5,active:!0,visible:!0},{id:"eventi",name:"Eventi",link:"#/app/eventi",icon:"fa-bullhorn",type:"simple",section:1,order:6,active:!0,visible:!0},{id:"promozioni",name:"Promozioni",link:"#/app/promozioni",icon:"fa-trophy",type:"simple",section:1,order:7,active:n.wmc_data.promozioni,visible:!0},{id:"coupon",name:"Coupon",link:"#/app/coupon",icon:"fa-gavel",type:"simple",section:1,order:8,active:n.wmc_data.coupon,visible:!0},{id:"recensioni",name:"Recensioni",link:"#/app/recensioni",icon:"fa-commenting-o",type:"simple",section:1,order:9,active:!0,visible:!0},{id:"gallery",name:"Gallery",link:"#/app/gallery",icon:"fa-picture-o",type:"simple",section:1,order:10,active:!0,visible:!0},{id:"riepilogo",name:"Report",link:"#/app/riepilogo",icon:"fa-line-chart",type:"simple",section:1,order:11,active:!0,visible:!0},{id:"help",name:"Help",link:"#/app/help",icon:"fa-question",type:"simple",section:2,order:0,active:!0,visible:!0}]};break;default:e.menu_version="base",e.menu_base=[{id:"home",name:"Home",link:"#/app/home",icon:"fa-home",type:"simple",section:0,order:0,active:!0,visible:!0},{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:n.wmc_data.chat,visible:!0},{id:"rubrica",name:"Rubrica",link:"#/app/rubrica",icon:"fa-users",type:"simple",section:1,order:4,active:!0,visible:!0},{id:"contatti",name:"Contattaci",link:"#/app/contatti",icon:"fa-phone",type:"simple",section:2,order:1,active:!0,visible:Object.keys(n.support).length>0},{id:"professional",name:"Professional",link:"#/app/professional",icon:"fa-level-up",type:"simple",section:2,order:2,active:!0,visible:!0}]}e.showModuliChange=function(){e.showModuliInattivi=1==e.showModuliInattivi?!1:!0;var i=1==e.showModuliInattivi?"Moduli ripristinati":"Moduli nascosti";window.localStorage.showModuliInattivi=e.showModuliInattivi,a.show(i,"short","bottom")}}]).controller("HomeCtrl",["$scope","$state","$ionicLoading","$ionicHistory","$cordovaNetwork","$cordovaToast","Auth","Database","PushState","Chats","NavBadges",function(e,i,a,o,t,n,s,c,r,l,d){var p=s.getUserData(null);e.badges=d.getBadges(),e.titolo=p.titolo_scheda,e.username=p.nome_utente,e.filename=p.filepath,e.chat_disabled="0"==p.wmc_data.chat?!0:!1,e.menu_home_list=[{id:"notifiche",name:"Notifiche",link:"#/app/notifiche",icon:"fa-bell",type:"badge",section:1,order:1,active:!0,visible:!0},{id:"convalide",name:"Convalide",link:"#/app/convalide",icon:"fa-check-circle",type:"badge",section:1,order:2,active:!0,visible:!0},{id:"chat",name:"Chat",link:"#/app/chat",icon:"fa-comments",type:"badge",section:1,order:3,active:p.wmc_data.chat,visible:!0}],e.settings={enablePushNotifications:"true"===window.localStorage.enablePushNotifications?!0:!1,chatAvailable:"false"===window.localStorage.chatAvailable?!1:!0},e.chatAvailableChange=function(){r.toggleChat(e.settings.chatAvailable).then(function(){window.localStorage.chatAvailable=e.settings.chatAvailable;var i=e.settings.chatAvailable===!0?"Chat attivata":"Chat disattivata";n.show(i,"short","bottom"),e.settings.chatAvailable===!1?l.breakChat():(l.init(),l.all(),o.clearCache(),o.clearHistory())},function(){n.show("Errore cambio stato Chat","short","bottom")})},e.pushNotificationChange=function(){if(e.settings.enablePushNotifications){var i={id_scheda:window.localStorage.id_scheda};r.register(i).then(function(){e.settings.enablePushNotifications=!0,n.show("Notifiche attivate","short","bottom")},function(){e.settings.enablePushNotifications=!1,n.show("Errore attivazione notifiche","short","bottom")})}else r.unregister().then(function(){e.settings.enablePushNotifications=!1,n.show("Notifiche disattivate","short","bottom")},function(){e.settings.enablePushNotifications=!0,n.show("Errore disattivazione notifiche","short","bottom")});window.localStorage.enablePushNotifications=e.settings.enablePushNotifications},e.logout_disabled="online"==window.localStorage.network?!1:!0,e.$watch(function(){return window.localStorage.network},function(i,a){void 0!==i&&i!=a&&(e.logout_disabled="online"==i?!1:!0)}),e.logout=function(){return t.isOffline()?(n.show("Nessuna connessione dati","short","bottom"),!1):(a.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),void s.logout().then(function(){window.database.isReady?window.database.mSQLite.transaction(function(e){e.executeSql("UPDATE OR IGNORE auth SET regid = NULL, id_scheda = NULL WHERE id = 1;")},function(){},function(){}):window.database.addQueue("UPDATE OR IGNORE auth SET regid = NULL, id_scheda = NULL WHERE id = 1;",function(){}),a.hide(),i.go("login"),o.clearCache(),o.clearHistory()},function(){a.hide()}))}}]).controller("LoginCtrl",["$scope","$rootScope","$state","$ionicLoading","$cordovaNetwork","$cordovaToast","Auth","Database","Convalide","Chats","NavBadges",function(e,i,a,o,t,n,s,c,r,l){e.credentials={username:"",password:"",remember:!1},e.auth_error=null,e.submitted=!1,e.login_disabled=!1,e.rememberAvailability=!1;var d="SELECT id, id_scheda, regid, app_type, app_version, username, timestamp FROM auth WHERE username IS NOT NULL LIMIT 0,1;";window.database.isReady?window.database.mSQLite.executeSql(d,[],function(i){if(e.rememberAvailability=!0,i.rows.length>0){var o=(new Date).getTime();null!=i.rows.item(0).regid&&i.rows.item(0).timestamp>o?(window.localStorage.regid=i.rows.item(0).regid,window.localStorage.id_scheda=i.rows.item(0).id_scheda,window.localStorage.APP_VERSION=i.rows.item(0).app_version,a.go("/app/home")):(e.credentials.username=i.rows.item(0).username,e.credentials.remember=!0)}}):window.database.addQueue(d,function(i,o){if(e.rememberAvailability=!0,o.rows.length>0){var t=(new Date).getTime();null!=o.rows.item(0).regid&&o.rows.item(0).timestamp>t?(window.localStorage.regid=o.rows.item(0).regid,window.localStorage.id_scheda=o.rows.item(0).id_scheda,window.localStorage.APP_VERSION=o.rows.item(0).app_version,a.go("/app/home")):(e.credentials.username=o.rows.item(0).username,e.credentials.remember=!0)}}),e.$watch(function(){return window.localStorage.network},function(i,a){void 0!==i&&i!=a&&(e.login_disabled="online"==i?!1:!0)}),e.login=function(){if(this.loginForm.$valid){if(cordova.plugins.Keyboard.isVisible&&cordova.plugins.Keyboard.close(),window.localStorage.network=t.isOnline()?"online":"offline",t.isOffline())return n.show("Nessuna connessione dati","short","bottom"),!1;o.show({template:"<ion-spinner></ion-spinner>",noBackdrop:!1}),s.login(e.credentials.username,e.credentials.password).then(function(t){e.auth_error=!1,s.storeAuthInfo(t.data),r.refreshList(),l.init(),l.all().then(function(e){i.NRchats=e}),d="DELETE FROM auth;",window.database.isReady?window.database.mSQLite.transaction(function(i){if(i.executeSql(d,[],function(){},function(){}),e.credentials.remember){var a=(new Date).getTime()+2592e6;d="REPLACE INTO auth (id, id_scheda, regid, app_type, app_version, username, timestamp) VALUES (1, ?, NULL, ?, ?, ?, ?) ",i.executeSql(d,[t.data.id_scheda,"myOverplace","2",e.credentials.username,a],function(){},function(){})}},function(){o.hide(),a.go("app.home",{},{reload:!0})},function(){o.hide(),a.go("app.home",{},{reload:!0})}):window.database.addQueue(d,function(i){if(e.credentials.remember){var n=(new Date).getTime()+2592e6;d="REPLACE INTO auth (id, id_scheda, regid, app_type, app_version, username, timestamp) VALUES (1, ?, NULL, ?, ?, ?, ?) ",i.executeSql(d,[t.data.id_scheda,"myOverplace","2",e.credentials.username,n],function(){o.hide(),a.go("app.home",{},{reload:!0})})}})},function(){e.auth_error=!0,o.hide(),n.show("Indirizzo email o password errati","short","center")})}else this.loginForm.submitted=!0}}]).controller("ContattiCtrl",["$scope","Auth",function(e,i){var a=i.getUserData("support");e.isSupport=Object.keys(a).length>0,e.isSupport&&(e.support_phone=void 0!==a.phone&&null!==a.phone&&a.phone.length>0?a.phone:null,e.support_email=void 0!==a.email&&null!==a.email&&a.email.length>0?a.email:null)}]);