angular.module("convalide.services",[]).factory("Convalide",["$http","$q","$cordovaToast","ApiConfig","NavBadges","Cache",function(e,n,o,a,d,i){var c=this;return this.getAll=function(){var o=n.defer();i.convalideCache=[],i.convalideCacheAll=[],i.convalideCacheId={};var d={},c=a.ovpEndpoint+"convalide/"+window.localStorage.id_scheda+"/fields";return d[a.wsKey]="JSON_CALLBACK",d.nocache=(new Date).getTime(),e({method:"JSONP",url:c,params:d,cache:!1}).success(function(e){for(var n=[],a=[],d=[],c=[],l=void 0!==window.localStorage.convalideRemoved&&window.localStorage.convalideRemoved.length>0&&JSON.parse(window.localStorage.convalideRemoved).length>0?JSON.parse(window.localStorage.convalideRemoved):[],t=e.length,r=0;t>r;r++){i.convalideCacheId[e[r].id]=e[r];var v=l.length>0&&-1!=l.indexOf(e[r].id)?!1:!0;"checkin"==e[r].type&&(0==e[r].stato?(v&&d.push(e[r]),n.push(e[r])):(v&&c.push(e[r]),a.push(e[r]))),"prenotazione"==e[r].type&&(1==e[r].stato?(v&&d.push(e[r]),n.push(e[r])):(v&&c.push(e[r]),a.push(e[r])))}return i.convalideCache={pending:d,approved:c},i.convalideCacheAll={pending:n,approved:a},o.resolve(i.convalideCache)}).error(function(){return o.reject()})},{refreshList:function(){var e=n.defer();return c.getAll().then(function(n){return d.setBadges("convalide",i.convalideCache.pending.length),e.resolve(n.data)},function(){return e.reject()})},count:function(){d.setBadges("convalide",i.convalideCache.pending.length)},getList:function(){return void 0!==i.convalideCache.pending||void 0!==i.convalideCache.approved?i.convalideCache:this.refreshList()},getTotalCount:function(){var e=void 0!==i.convalideCacheAll.pending&&void 0!==i.convalideCacheAll.approved?i.convalideCacheAll.pending.length+i.convalideCacheAll.approved.length:0;return e},resync:function(){if(void 0!==window.localStorage.convalideRemoved&&window.localStorage.convalideRemoved.length>0&&JSON.parse(window.localStorage.convalideRemoved).length>0){window.localStorage.convalideRemoved=[];var e=JSON.stringify(i.convalideCacheAll);i.convalideCache=JSON.parse(e),d.setBadges("convalide",i.convalideCache.pending.length)}},"delete":function(e,n){i.convalideCache[n].splice(i.convalideCache[n].indexOf(e),1);var o=void 0!==window.localStorage.convalideRemoved&&window.localStorage.convalideRemoved.length>0&&JSON.parse(window.localStorage.convalideRemoved).length>0?JSON.parse(window.localStorage.convalideRemoved):[];-1==o.indexOf(e.id)&&(o.push(e.id),window.localStorage.convalideRemoved=JSON.stringify(o)),this.count()},move:function(c,l){var t=n.defer(),r=l?"accept":"reject",v=a.ovpEndpoint+"convalide/"+window.localStorage.id_scheda+"/"+c.type+"/"+r+"/"+c.id+"/fields",h=[];return h[a.wsKey]="JSON_CALLBACK",h.nocache=(new Date).getTime(),e({method:"JSONP",url:v,params:h,cache:!1}).success(function(e){return i.convalideCache.pending.splice(i.convalideCache.pending.indexOf(c),1),i.convalideCacheAll.pending.splice(i.convalideCacheAll.pending.indexOf(c),1),c.stato=e.stato,i.convalideCache.approved.unshift(c),i.convalideCacheAll.approved.unshift(c),d.setBadges("convalide",i.convalideCache.pending.length),o.show(e.data,"long","bottom"),t.resolve()}).error(function(e){return o.show(e.data,"long","bottom"),t.reject()})},addConvalida:function(){return this.refreshList()}}}]);